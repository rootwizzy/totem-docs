<!DOCTYPE html><html lang="en"><head><title>thinkspace-markup/addon/services/manager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="thinkspace-markup/addon/services/manager"><meta name="groc-project-path" content="thinkspace-markup/addon/services/manager.coffee"><meta name="groc-branch-path" content="feature/rap-analytics-styling"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-client"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-client/blob/feature/rap-analytics-styling/thinkspace-markup/addon/services/manager.coffee">thinkspace-markup/addon/services/manager.coffee</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper">import ember          from <span class="hljs-string">'ember'</span>
import ns             from <span class="hljs-string">'totem/ns'</span>
import tc             from <span class="hljs-string">'totem/cache'</span>
import ta             from <span class="hljs-string">'totem/ds/associations'</span>
import totem_messages from <span class="hljs-string">'totem-messages/messages'</span>
import totem_scope    from <span class="hljs-string">'totem/scope'</span>
import base  from <span class="hljs-string">'thinkspace-base/services/base'</span>
import ajax  from <span class="hljs-string">'totem/ajax'</span>

export default base.extend</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="services">Services</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">addons</span>:    ember.inject.service()
  <span class="hljs-attribute">taf</span>:       ember.inject.service()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="properties">Properties</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">library</span>:          <span class="hljs-literal">null</span>
  <span class="hljs-attribute">is_library_open</span>:  <span class="hljs-literal">false</span>
  <span class="hljs-attribute">is_pdf</span>:           <span class="hljs-literal">false</span>
  <span class="hljs-attribute">is_pdf_loading</span>:   <span class="hljs-literal">false</span>
  <span class="hljs-attribute">is_comments_open</span>: <span class="hljs-literal">false</span>

  <span class="hljs-attribute">selected_library_tags</span>: []</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Registries</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">discussion_components</span>: []
  <span class="hljs-attribute">marker_components</span>:     []
  <span class="hljs-attribute">comment_components</span>:    []

  <span class="hljs-attribute">selectors</span>:
    <span class="hljs-attribute">comment_gutter_wrapper</span>: <span class="hljs-string">'#ts-markup_comment-gutter-wrapper'</span>
    <span class="hljs-attribute">comment_gutter_header</span>:  <span class="hljs-string">'#ts-markup_comment-gutter-header'</span>
    <span class="hljs-attribute">content_wrapper</span>:        <span class="hljs-string">'#content-wrapper'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="computed-properties">Computed properties</h3>
<h3 id="opening--closing">Opening / closing</h3></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">open_library</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>addons  = @get &#39;addons&#39;
thinkspace = @get &#39;thinkspace&#39;
addons.set_right_pocket_width 2</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-property">@set</span> <span class="hljs-string">'is_library_open'</span>, <span class="hljs-literal">true</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> bind_sticky_columns</span></p>
<p>thinkspace.minimize_toolbar()</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">close_library</span>: <span class="hljs-function">-&gt;</span>
    addons  = <span class="hljs-property">@get</span> <span class="hljs-string">'addons'</span>
    thinkspace = <span class="hljs-property">@get</span> <span class="hljs-string">'thinkspace'</span>
    addons.set_right_pocket_width <span class="hljs-number">1</span>
    <span class="hljs-property">@set</span> <span class="hljs-string">'is_library_open'</span>, <span class="hljs-literal">false</span>
    thinkspace.expand_toolbar()
    <span class="hljs-property">@bind_sticky_columns</span>()
    <span class="hljs-property">@reset_selected_library_comment</span>()
    <span class="hljs-property">@reset_selected_library_tags</span>()

  <span class="hljs-attribute">open_comments</span>: <span class="hljs-function">-&gt;</span>
    ember.run.schedule <span class="hljs-string">'afterRender'</span>, <span class="hljs-function">=&gt;</span>
      <span class="hljs-property">@bind_sticky_columns</span>()
      <span class="hljs-property">@set_is_pdf_loaded</span>() <span class="hljs-keyword">if</span> <span class="hljs-property">@get_is_pdf</span>()
      <span class="hljs-property">@set_is_comments_open</span>()

  <span class="hljs-attribute">close_comments</span>: <span class="hljs-function">-&gt;</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> close_library</span></p></div></div><div class="code"><div class="wrapper">    <span class="hljs-property">@reset_is_comments_open</span>()

  <span class="hljs-attribute">bind_sticky_columns</span>: <span class="hljs-function">-&gt;</span>
    ember.run.schedule <span class="hljs-string">'afterRender'</span>, <span class="hljs-function">=&gt;</span>
      <span class="hljs-property">@get</span>(<span class="hljs-string">'thinkspace'</span>).bind_sticky_columns()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="data-getters">Data getters</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_current_commenterable</span>: <span class="hljs-function">-&gt;</span>
    totem_scope.get_current_user()

  <span class="hljs-attribute">get_comments</span>: <span class="hljs-function"><span class="hljs-params">(options={})</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      ownerable   = options.ownerable
      authable    = options.authable
      query       =
        <span class="hljs-attribute">action</span>:    <span class="hljs-string">'fetch'</span>
        <span class="hljs-attribute">ownerable</span>: ownerable
        <span class="hljs-attribute">authable</span>:  authable
        <span class="hljs-attribute">auth</span>:
          <span class="hljs-attribute">view_ids</span>:         ownerable.get(<span class="hljs-string">'id'</span>)
          <span class="hljs-attribute">view_type</span>:        totem_scope.get_record_path(ownerable)
      tc.query(ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'comment'</span>), query).<span class="hljs-keyword">then</span> (comments) =&gt;
        resolve(comments)

  <span class="hljs-attribute">get_discussions</span>: <span class="hljs-function"><span class="hljs-params">(options={})</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      ownerable      = options.ownerable
      authable       = options.authable
      discussionable = options.discussionable
      query          =
        <span class="hljs-attribute">action</span>:    <span class="hljs-string">'fetch'</span>
        <span class="hljs-attribute">model</span>:     ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'discussion'</span>)
        <span class="hljs-attribute">ownerable</span>: ownerable
        <span class="hljs-attribute">authable</span>: authable
        <span class="hljs-attribute">data</span>:
          <span class="hljs-attribute">auth</span>:
            <span class="hljs-attribute">view_ids</span>:  ownerable.get(<span class="hljs-string">'id'</span>)
            <span class="hljs-attribute">view_type</span>: totem_scope.get_record_path(ownerable)
            <span class="hljs-attribute">discussionable_id</span>:   discussionable.get(<span class="hljs-string">'id'</span>)
            <span class="hljs-attribute">discussionable_type</span>: totem_scope.get_record_path(discussionable)
      totem_scope.add_auth_to_ajax_query(query)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.warn query</p></div></div><div class="code"><div class="wrapper">      ajax.object(query).<span class="hljs-keyword">then</span> (discussions) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.warn &#39;discussions&#39;, discussions</p></div></div><div class="code"><div class="wrapper">        resolve(discussions)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get_discussions: (options={}) -&gt;
  new ember.RSVP.Promise (resolve, reject) =&gt;
    ownerable      = options.ownerable
    authable       = options.authable
    discussionable = options.discussionable
    query          =
      action:    &#39;fetch&#39;
      model: ns.to_p(&#39;markup&#39;, &#39;discussion&#39;)
      auth:
        ownerable: ownerable
        authable:  authable
        view_ids:            ownerable.get(&#39;id&#39;)
        view_type:           totem_scope.get_record_path(ownerable)
        discussionable_id:   discussionable.get(&#39;id&#39;)
        discussionable_type: totem_scope.get_record_path(discussionable)
    ajax.object(query).then (discussions) =&gt;
      console.warn &#39;discussions&#39;, discussions
      resolve(discussions)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">set_anonymized_commenters</span>: <span class="hljs-function"><span class="hljs-params">(discussions, options={})</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      promises = ember.makeArray()
      discussions.forEach (discussion) =&gt;
        promises.pushObject discussion.get_commenterables()
      ember.RSVP.Promise.all(promises).<span class="hljs-keyword">then</span> (commenterables) =&gt;
        commenterables = <span class="hljs-property">@get</span>(<span class="hljs-string">'taf'</span>).flatten(commenterables).uniq().sortBy <span class="hljs-string">'id'</span>
        commenterables = <span class="hljs-property">@get</span>(<span class="hljs-string">'taf'</span>).shuffle(commenterables) <span class="hljs-keyword">if</span> options.shuffle
        map = ember.Map.create()
        commenterables.forEach (commenterable, index) =&gt;
          map.set commenterable, index + <span class="hljs-number">1</span>
        <span class="hljs-property">@set</span> <span class="hljs-string">'anonymized_commenters'</span>, map
        resolve map

  <span class="hljs-attribute">get_anonymized_commenter</span>: <span class="hljs-function"><span class="hljs-params">(commenter)</span> -&gt;</span>
    commenters = <span class="hljs-property">@get</span>(<span class="hljs-string">'anonymized_commenters'</span>)
    <span class="hljs-built_in">console</span>.error <span class="hljs-string">'[markup:manager] get_anonymized_commetner: anonymized_commenters has not been set yet.'</span> <span class="hljs-keyword">unless</span> ember.isPresent commenters
    commenters.get commenter

  <span class="hljs-attribute">get_library_for_current_user</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      library = <span class="hljs-property">@get</span> <span class="hljs-string">'library'</span>
      <span class="hljs-keyword">return</span> resolve(library) <span class="hljs-keyword">if</span> ember.isPresent(library)
      query =
        <span class="hljs-attribute">action</span>: <span class="hljs-string">'fetch'</span>
      tc.query(ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'library'</span>), query, <span class="hljs-attribute">single</span>: <span class="hljs-literal">true</span>).<span class="hljs-keyword">then</span> (library) =&gt;
        <span class="hljs-property">@set</span> <span class="hljs-string">'library'</span>, library
        resolve(library)
      , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> <span class="hljs-property">@error</span> error
    , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> <span class="hljs-property">@error</span> error</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="library-additions">Library additions</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">add_comment_to_library</span>: <span class="hljs-function"><span class="hljs-params">(comment)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      <span class="hljs-keyword">return</span> resolve(<span class="hljs-literal">null</span>) <span class="hljs-keyword">unless</span> ember.isPresent(comment)
      <span class="hljs-property">@get_library_for_current_user</span>().<span class="hljs-keyword">then</span> (library) =&gt;
        text            = comment.get(<span class="hljs-string">'comment'</span>)
        library_comment = totem_scope.get_store().createRecord ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'library_comment'</span>),
          <span class="hljs-attribute">comment</span>:                           text
          <span class="hljs-attribute">uses</span>:                              <span class="hljs-number">0</span>
          <span class="hljs-attribute">last_used</span>:                         <span class="hljs-keyword">new</span> Date()
          <span class="hljs-attribute">user_id</span>:                           totem_scope.get_current_user_id()
          <span class="hljs-string">"<span class="hljs-subst">#{ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'library'</span>)}</span>"</span>: library
        library_comment.save().<span class="hljs-keyword">then</span> =&gt;
          resolve(library_comment)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="comment-addition">Comment addition</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">add_comment</span>: <span class="hljs-function"><span class="hljs-params">(options={})</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      comment_text  = <span class="hljs-property">@get_comment_from_options</span>(options) <span class="hljs-keyword">or</span> <span class="hljs-string">'New comment'</span>
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a comment without valid text."</span> <span class="hljs-keyword">unless</span> ember.isPresent(comment_text)
      commenterable = options.commenterable <span class="hljs-comment"># Who left the comment</span>
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a comment without a valid commenterable."</span> <span class="hljs-keyword">unless</span> ember.isPresent(commenterable)
      discussion    = options.discussion
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a comment without a valid discussion."</span> <span class="hljs-keyword">unless</span> ember.isPresent(discussion)
      parent        = options.parent
      position      = options.position <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
      save          = options.save <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Parent is set up front to avoid the &#39;warp to top, then back down&#39; issue in the list.
=&gt; parent_id presence is used in the &#39;is_child&#39; check, so need to set it here, too.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> ember.isPresent(parent)
        comment = <span class="hljs-property">@get_store</span>().createRecord ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'comment'</span>),
          <span class="hljs-string">'thinkspace/markup/discussion'</span>: discussion,
          <span class="hljs-string">'discussion_id'</span>:                discussion.get(<span class="hljs-string">'id'</span>),
          <span class="hljs-string">'thinkspace/markup/parent'</span>:     parent,
          <span class="hljs-string">'parent_id'</span>:                    parent.get(<span class="hljs-string">'id'</span>),
          <span class="hljs-attribute">position</span>:                       position
          <span class="hljs-attribute">created_at</span>:                     <span class="hljs-keyword">new</span> Date(),
          <span class="hljs-attribute">comment</span>:                        comment_text
      <span class="hljs-keyword">else</span>
        comment = <span class="hljs-property">@get_store</span>().createRecord ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'comment'</span>),
          <span class="hljs-string">'thinkspace/markup/discussion'</span>: discussion,
          <span class="hljs-string">'discussion_id'</span>:                discussion.get(<span class="hljs-string">'id'</span>),
          <span class="hljs-attribute">position</span>:                       position
          <span class="hljs-attribute">created_at</span>:                     <span class="hljs-keyword">new</span> Date(),
          <span class="hljs-attribute">comment</span>:                        comment_text
      <span class="hljs-property">@set_polymorphic_on_record</span> comment, commenterable, <span class="hljs-string">'commenterable'</span>
      <span class="hljs-keyword">if</span> save
        comment.save().<span class="hljs-keyword">then</span> =&gt; resolve(comment)
      <span class="hljs-keyword">else</span>
        resolve(comment)

  <span class="hljs-attribute">add_discussion</span>: <span class="hljs-function"><span class="hljs-params">(options={})</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      value          = options.value <span class="hljs-keyword">or</span> <span class="hljs-keyword">new</span> Object
      authable       = options.authable
      ownerable      = options.ownerable
      creatorable    = options.creatorable
      discussionable = options.discussionable
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a discussion without a valid authable."</span>       <span class="hljs-keyword">unless</span> ember.isPresent(authable)
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a discussion without a valid ownerable."</span>      <span class="hljs-keyword">unless</span> ember.isPresent(ownerable)
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a discussion without a valid creatorable."</span>    <span class="hljs-keyword">unless</span> ember.isPresent(creatorable)
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"[markup:manager] Cannot create a discussion without a valid discussionable."</span> <span class="hljs-keyword">unless</span> ember.isPresent(discussionable)
      discussion = <span class="hljs-property">@get_store</span>().createRecord ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'discussion'</span>),
        <span class="hljs-attribute">value</span>:          value
        <span class="hljs-attribute">authable</span>:       authable
        <span class="hljs-attribute">ownerable</span>:      ownerable
        <span class="hljs-attribute">creatorable</span>:    creatorable
        <span class="hljs-attribute">discussionable</span>: discussionable</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the non-relationship _id, _type values for store filter.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-property">@set_polymorphic_on_record</span> discussion, authable,       <span class="hljs-string">'authable'</span>
      <span class="hljs-property">@set_polymorphic_on_record</span> discussion, ownerable,      <span class="hljs-string">'ownerable'</span>
      <span class="hljs-property">@set_polymorphic_on_record</span> discussion, creatorable,    <span class="hljs-string">'creatorable'</span>
      <span class="hljs-property">@set_polymorphic_on_record</span> discussion, discussionable, <span class="hljs-string">'discussionable'</span>
      <span class="hljs-keyword">if</span> options.save
        discussion.save().<span class="hljs-keyword">then</span> =&gt; resolve(discussion)
      <span class="hljs-keyword">else</span>
        resolve(discussion)

  <span class="hljs-attribute">add_comment_to_discussion_and_edit</span>: <span class="hljs-function"><span class="hljs-params">(model, options={})</span> -&gt;</span>
    options.edit = <span class="hljs-literal">true</span>
    <span class="hljs-property">@add_comment_to_discussion</span>(model, options)

  <span class="hljs-attribute">add_comment_to_discussion</span>: <span class="hljs-function"><span class="hljs-params">(model, options={})</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">'[markup:manager] WARNING: Commenterable not passed in with options for `add_comment_and_edit_discussion`'</span> <span class="hljs-keyword">unless</span> options.commenterable
      options.discussion = model
      options.save       = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> options.library_comment
      <span class="hljs-property">@add_comment</span>(options).<span class="hljs-keyword">then</span> (comment) =&gt;
        ember.run.schedule <span class="hljs-string">'afterRender'</span>, <span class="hljs-function">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Do not edit the comment right away unless specified.</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">if</span> options.edit
            component = <span class="hljs-property">@get_comment_component_for_comment</span>(comment)
            component.set_is_editing() <span class="hljs-keyword">if</span> component
          discussion_component = <span class="hljs-property">@get_discussion_component_for_discussion</span>(model)
          <span class="hljs-property">@scroll_right_pocket_to_component</span>(discussion_component)

  <span class="hljs-attribute">get_comment_from_options</span>: <span class="hljs-function"><span class="hljs-params">(options={})</span> -&gt;</span>
    library_comment = options.library_comment
    comment         = options.comment
    <span class="hljs-keyword">if</span> ember.isPresent(library_comment) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> library_comment.get(<span class="hljs-string">'comment'</span>) <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> comment</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="scroll-helpers">Scroll helpers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">scroll_right_pocket_to_discussion</span>: <span class="hljs-function"><span class="hljs-params">(model)</span> -&gt;</span>
    component = <span class="hljs-property">@get_discussion_component_for_discussion</span>(model)
    <span class="hljs-property">@scroll_right_pocket_to_component</span>(component)

  <span class="hljs-attribute">scroll_right_pocket_to_component</span>: <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span>
    el = <span class="hljs-property">@get_$comment_gutter_wrapper</span>()
    <span class="hljs-property">@scroll_el_to_component</span>(el, component)

  <span class="hljs-attribute">scroll_content_wrapper_to_component</span>: <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span>
    el = <span class="hljs-property">@get_$content_wrapper</span>()
    <span class="hljs-property">@scroll_el_to_component</span>(el, component)

  <span class="hljs-attribute">scroll_el_to_component</span>: <span class="hljs-function"><span class="hljs-params">(el, component)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> component
    $component    = component.$()
    scroll_top    = $component.position().top
    el.animate
      <span class="hljs-attribute">scrollTop</span>: scroll_top
    component.set_is_scrolled_to() <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> component.set_is_scrolled_to == <span class="hljs-string">'function'</span> <span class="hljs-keyword">and</span> !component.get(<span class="hljs-string">'isDestroying'</span>) <span class="hljs-keyword">and</span> !component.get(<span class="hljs-string">'isDestroyed'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="highlight-helpers">Highlight helpers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">highlight_discussion</span>: <span class="hljs-function"><span class="hljs-params">(model)</span> -&gt;</span>
    components = <span class="hljs-property">@get_discussion_components</span>()
    discussion = <span class="hljs-literal">null</span>
    components.forEach (component) =&gt;
      <span class="hljs-keyword">if</span> component.get(<span class="hljs-string">'model'</span>) == model
        component.set_is_highlighted()
        discussion = component
      <span class="hljs-keyword">else</span>
        component.reset_is_highlighted()
    components = <span class="hljs-property">@get_marker_components</span>()
    marker     = <span class="hljs-literal">null</span>
    components.forEach (component) =&gt;
      <span class="hljs-keyword">if</span> component.get(<span class="hljs-string">'model'</span>) == model
        component.set_is_highlighted()
        marker = component
      <span class="hljs-keyword">else</span>
        component.reset_is_highlighted()
    <span class="hljs-property">@scroll_right_pocket_to_component</span>(discussion)  <span class="hljs-keyword">if</span> discussion
    <span class="hljs-property">@scroll_content_wrapper_to_component</span>(marker) <span class="hljs-keyword">if</span> marker</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="helpers">Helpers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">set_polymorphic_on_record</span>: <span class="hljs-function"><span class="hljs-params">(record, polymorphic, type)</span> -&gt;</span>
    record.set <span class="hljs-string">"<span class="hljs-subst">#{type}</span>_id"</span>,   polymorphic.get(<span class="hljs-string">'id'</span>)
    record.set <span class="hljs-string">"<span class="hljs-subst">#{type}</span>_type"</span>, totem_scope.get_record_path(polymorphic)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="pdf-helpers">PDF helpers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">set_is_pdf</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'is_pdf'</span>, <span class="hljs-literal">true</span>
  <span class="hljs-attribute">reset_is_pdf</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'is_pdf'</span>, <span class="hljs-literal">false</span>
  <span class="hljs-attribute">get_is_pdf</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'is_pdf'</span>

  <span class="hljs-attribute">set_is_pdf_loading</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'is_pdf_loading'</span>, <span class="hljs-literal">true</span>
  <span class="hljs-attribute">reset_is_pdf_loading</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'is_pdf_loading'</span>, <span class="hljs-literal">false</span>
  <span class="hljs-attribute">get_is_pdf_loading</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'is_pdf_loading'</span>

  <span class="hljs-attribute">set_is_pdf_loaded</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@reset_is_pdf_loading</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="selector-helpers">Selector helpers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_comment_gutter_wrapper_selector</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'selectors.comment_gutter_wrapper'</span>
  <span class="hljs-attribute">get_$comment_gutter_wrapper</span>:         <span class="hljs-function">-&gt;</span> $(<span class="hljs-property">@get_comment_gutter_wrapper_selector</span>())
  <span class="hljs-attribute">get_comment_gutter_header_selector</span>:  <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'selectors.comment_gutter_header'</span>
  <span class="hljs-attribute">get_$comment_gutter_header</span>:          <span class="hljs-function">-&gt;</span> $(<span class="hljs-property">@get_comment_gutter_header_selector</span>())
  <span class="hljs-attribute">get_content_wrapper_selector</span>:        <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'selectors.content_wrapper'</span>
  <span class="hljs-attribute">get_$content_wrapper</span>:                <span class="hljs-function">-&gt;</span> $(<span class="hljs-property">@get_content_wrapper_selector</span>())</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="measuring">Measuring</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_header_height</span>: <span class="hljs-function">-&gt;</span>
    $header = <span class="hljs-property">@get_$comment_gutter_header</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-keyword">unless</span> ember.isPresent($header)
    $header.outerHeight()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="component-registries">Component registries</h3>
<p>TODO: Could type be inferred from component?</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">add_component_to_registry</span>: <span class="hljs-function"><span class="hljs-params">(type, component)</span> -&gt;</span>
    components = @[<span class="hljs-string">"get_<span class="hljs-subst">#{type}</span>_components"</span>]()
    components.pushObject(component) <span class="hljs-keyword">unless</span> components.includes(component)

  <span class="hljs-attribute">remove_component_from_registry</span>: <span class="hljs-function"><span class="hljs-params">(type, component)</span> -&gt;</span>
    components = @[<span class="hljs-string">"get_<span class="hljs-subst">#{type}</span>_components"</span>]()
    components.removeObject(component) <span class="hljs-keyword">if</span> components.includes(component)

  <span class="hljs-attribute">add_discussion_component</span>:    <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span> <span class="hljs-property">@add_component_to_registry</span>(<span class="hljs-string">'discussion'</span>, component)
  <span class="hljs-attribute">remove_discussion_component</span>: <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span> <span class="hljs-property">@remove_component_from_registry</span>(<span class="hljs-string">'discussion'</span>, component)
  <span class="hljs-attribute">reset_discussion_components</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'discussion_components'</span>, <span class="hljs-keyword">new</span> Array
  <span class="hljs-attribute">get_discussion_components</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'discussion_components'</span>

  <span class="hljs-attribute">add_marker_component</span>:    <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span> <span class="hljs-property">@add_component_to_registry</span>(<span class="hljs-string">'marker'</span>, component)
  <span class="hljs-attribute">remove_marker_component</span>: <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span> <span class="hljs-property">@remove_component_from_registry</span>(<span class="hljs-string">'marker'</span>, component)
  <span class="hljs-attribute">reset_marker_components</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'marker_components'</span>, <span class="hljs-keyword">new</span> Array
  <span class="hljs-attribute">get_marker_components</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'marker_components'</span>

  <span class="hljs-attribute">add_comment_component</span>:    <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span> <span class="hljs-property">@add_component_to_registry</span>(<span class="hljs-string">'comment'</span>, component)
  <span class="hljs-attribute">remove_comment_component</span>: <span class="hljs-function"><span class="hljs-params">(component)</span> -&gt;</span> <span class="hljs-property">@remove_component_from_registry</span>(<span class="hljs-string">'comment'</span>, component)
  <span class="hljs-attribute">reset_comment_components</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'comment_components'</span>, <span class="hljs-keyword">new</span> Array
  <span class="hljs-attribute">get_comment_components</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'comment_components'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: On register, could add to a model-based map to not filter on each request.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_marker_component_for_discussion</span>: <span class="hljs-function"><span class="hljs-params">(model)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[markup:manager] Getting marker components for discussion: "</span>, model
    <span class="hljs-property">@get_marker_components</span>().findBy <span class="hljs-string">'model'</span>, model

  <span class="hljs-attribute">get_discussion_component_for_discussion</span>: <span class="hljs-function"><span class="hljs-params">(model)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[markup:manager] Getting discussion components for discussion: "</span>, model
    <span class="hljs-property">@get_discussion_components</span>().findBy <span class="hljs-string">'model'</span>, model

  <span class="hljs-attribute">get_comment_component_for_comment</span>: <span class="hljs-function"><span class="hljs-params">(model)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[markup:manager] Getting comment components for comment: "</span>, model
    <span class="hljs-property">@get_comment_components</span>().findBy <span class="hljs-string">'model'</span>, model</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="discussion-filters">Discussion filters</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">discussion_discussionable_is_in_store</span>: <span class="hljs-function"><span class="hljs-params">(discussion)</span> -&gt;</span>
    discussionable = tc.peek_record totem_scope.standard_record_path(discussion.get(<span class="hljs-string">'discussionable_type'</span>)), discussion.get(<span class="hljs-string">'discussionable_id'</span>)
    ember.isPresent(discussionable)

  <span class="hljs-attribute">discussion_has_ownerable</span>: <span class="hljs-function"><span class="hljs-params">(discussion, ownerable=<span class="hljs-literal">null</span>)</span> -&gt;</span>
    ownerable = totem_scope.get_ownerable_record() <span class="hljs-keyword">unless</span> ownerable
    <span class="hljs-property">@discussion_has_polymorphic</span>(discussion, ownerable, <span class="hljs-string">'ownerable'</span>)

  <span class="hljs-attribute">discussion_has_authable</span>: <span class="hljs-function"><span class="hljs-params">(discussion, authable)</span> -&gt;</span>
    <span class="hljs-property">@discussion_has_polymorphic</span>(discussion, authable, <span class="hljs-string">'authable'</span>)

  <span class="hljs-attribute">discussion_has_discussionable</span>: <span class="hljs-function"><span class="hljs-params">(discussion, discussionable)</span> -&gt;</span>
    <span class="hljs-property">@discussion_has_polymorphic</span>(discussion, discussionable, <span class="hljs-string">'discussionable'</span>)

  <span class="hljs-attribute">discussion_has_polymorphic</span>: <span class="hljs-function"><span class="hljs-params">(discussion, record, type)</span> -&gt;</span>
    record_type      = totem_scope.standard_record_path(record)
    record_id        = parseInt record.get <span class="hljs-string">'id'</span>
    polymorphic_type = totem_scope.standard_record_path discussion.get <span class="hljs-string">"<span class="hljs-subst">#{type}</span>_type"</span>
    polymorphic_id   = parseInt discussion.get <span class="hljs-string">"<span class="hljs-subst">#{type}</span>_id"</span>
    ember.isEqual(record_type, polymorphic_type) <span class="hljs-keyword">and</span> ember.isEqual(record_id, polymorphic_id)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="library-interactions">Library interactions</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">set_selected_library_comment</span>:   <span class="hljs-function"><span class="hljs-params">(library_comment)</span> -&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'selected_library_comment'</span>, library_comment
  <span class="hljs-attribute">reset_selected_library_comment</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'selected_library_comment'</span>, <span class="hljs-literal">null</span>
  <span class="hljs-attribute">get_selected_library_comment</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'selected_library_comment'</span>

  <span class="hljs-attribute">add_selected_library_tag</span>:   <span class="hljs-function"><span class="hljs-params">(tag)</span> -&gt;</span>
    tags = <span class="hljs-property">@get_selected_library_tags</span>()
    tags.pushObject(tag) <span class="hljs-keyword">unless</span> tags.includes(tag)
  <span class="hljs-attribute">remove_selected_library_tag</span>: <span class="hljs-function"><span class="hljs-params">(tag)</span> -&gt;</span>
    tags = <span class="hljs-property">@get_selected_library_tags</span>()
    tags.removeObject(tag) <span class="hljs-keyword">if</span> tags.includes(tag)
  <span class="hljs-attribute">reset_selected_library_tags</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'selected_library_tags'</span>, <span class="hljs-keyword">new</span> Array
  <span class="hljs-attribute">get_selected_library_tags</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'selected_library_tags'</span>

  <span class="hljs-attribute">get_library_target_class</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-string">'ts-markup_library-target'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="discussion-number">Discussion number</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_discussion_number</span>: <span class="hljs-function"><span class="hljs-params">(discussions, discussion)</span> -&gt;</span> discussions.indexOf(discussion) + <span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="comment-openers">Comment openers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">set_is_comments_open</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'is_comments_open'</span>, <span class="hljs-literal">true</span>
  <span class="hljs-attribute">reset_is_comments_open</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@set</span> <span class="hljs-string">'is_comments_open'</span>, <span class="hljs-literal">false</span>
  <span class="hljs-attribute">get_is_comments_open</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span> <span class="hljs-string">'is_comments_open'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="misc-helpers">Misc. helpers</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">save_comment</span>: <span class="hljs-function"><span class="hljs-params">(comment)</span> -&gt;</span> comment.save()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get_store:    -&gt; @container.lookup(&#39;store:main&#39;)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_store</span>:    <span class="hljs-function">-&gt;</span> <span class="hljs-property">@store</span></div></div></div></div></body></html>