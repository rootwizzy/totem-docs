<!DOCTYPE html><html lang="en"><head><title>thinkspace-artifact/addon/components/bucket/file/pdf/file</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../../"><meta name="groc-document-path" content="thinkspace-artifact/addon/components/bucket/file/pdf/file"><meta name="groc-project-path" content="thinkspace-artifact/addon/components/bucket/file/pdf/file.coffee"><meta name="groc-branch-path" content="feature/rap-analytics-styling"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-client"><link rel="stylesheet" type="text/css" media="all" href="../../../../../../assets/style.css"><script type="text/javascript" src="../../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-client/blob/feature/rap-analytics-styling/thinkspace-artifact/addon/components/bucket/file/pdf/file.coffee">thinkspace-artifact/addon/components/bucket/file/pdf/file.coffee</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper">import ember  from <span class="hljs-string">'ember'</span>
import config from <span class="hljs-string">'totem-config/config'</span>
import ns     from <span class="hljs-string">'totem/ns'</span>
import ta     from <span class="hljs-string">'totem/ds/associations'</span>
import base  from <span class="hljs-string">'thinkspace-base/components/base'</span>

export default base.extend</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="services">Services</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">tvo</span>:    ember.inject.service()
  <span class="hljs-attribute">markup</span>: ember.inject.service ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'manager'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="properties">Properties</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">rendered_canvases</span>: []</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="computed-properties">Computed properties</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">pdf_worker_src</span>:    ember.computed -&gt; <span class="hljs-string">"<span class="hljs-subst">#{config.pdfjs.worker_src}</span>"</span>
  <span class="hljs-attribute">is_loading</span>:        ember.computed.reads <span class="hljs-string">'markup.is_pdf_loading'</span>

  <span class="hljs-attribute">discussions</span>: ember.computed <span class="hljs-string">'totem_scope.ownerable_record'</span>, <span class="hljs-function">-&gt;</span>
    promise  = <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt; 
      model  = <span class="hljs-property">@get</span> <span class="hljs-string">'model'</span>
      markup = <span class="hljs-property">@get</span> <span class="hljs-string">'markup'</span>
      discussions = <span class="hljs-property">@container</span>.lookup(<span class="hljs-string">'store:main'</span>).filter ns.to_p(<span class="hljs-string">'markup'</span>, <span class="hljs-string">'discussion'</span>), <span class="hljs-function"><span class="hljs-params">(discussion)</span> =&gt;</span> 
        markup.discussion_has_discussionable(discussion, model) <span class="hljs-keyword">and</span> markup.discussion_has_ownerable(discussion)
      resolve(discussions)
    ta.PromiseArray.create <span class="hljs-attribute">promise</span>: promise

  <span class="hljs-attribute">discussions_sort_by</span>: [<span class="hljs-string">'sort_by'</span>]
  <span class="hljs-attribute">sorted_discussions</span>: ember.computed.sort <span class="hljs-string">'discussions'</span>, <span class="hljs-string">'discussions_sort_by'</span>
  </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="observer">Observer</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">show_file_change</span>:  ember.observer <span class="hljs-string">'show_file'</span>, <span class="hljs-function">-&gt;</span> <span class="hljs-property">@load_and_show_pdf</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="components">Components</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="hljs-attribute">c_loader</span>:                            ns.to_p <span class="hljs-string">'common'</span>, <span class="hljs-string">'loader'</span>
  <span class="hljs-attribute">c_markup_discussion_markers_default</span>: ns.to_p <span class="hljs-string">'markup'</span>, <span class="hljs-string">'discussion'</span>, <span class="hljs-string">'markers'</span>, <span class="hljs-string">'default'</span>

  <span class="hljs-attribute">didInsertElement</span>:   <span class="hljs-function">-&gt;</span> <span class="hljs-property">@load_and_show_pdf</span>()  <span class="hljs-comment"># in case show_file is initially set as true (e.g. auto show files)</span>
  <span class="hljs-attribute">willDestroyElement</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-property">@get</span>(<span class="hljs-string">'markup'</span>).reset_is_pdf()
  <span class="hljs-attribute">init_base</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-built_in">console</span>.log <span class="hljs-string">'[pdf:file] File component: '</span>, @

  <span class="hljs-attribute">click</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>e.offsetX, e.offsetY is relative to each page of the PDF.
e.target is the <canvas> tag that is clicked.</p></div></div><div class="code"><div class="wrapper">    markup          = <span class="hljs-property">@get</span> <span class="hljs-string">'markup'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> markup.get_is_comments_open()
    target    = e.target
    <span class="hljs-keyword">if</span> target.tagName != <span class="hljs-string">'CANVAS'</span>
      <span class="hljs-property">@totem_messages</span>.error <span class="hljs-string">'You cannot create a new discussion on top of an existing discussion.'</span>
      <span class="hljs-keyword">return</span>
    page            = parseInt   e.target.getAttribute(<span class="hljs-string">'page'</span>)
    value           = {<span class="hljs-attribute">position</span>: {<span class="hljs-attribute">x</span>: e.offsetX, <span class="hljs-attribute">y</span>: e.offsetY, <span class="hljs-attribute">page</span>: page}}
    discussionable  = <span class="hljs-property">@get</span> <span class="hljs-string">'model'</span>
    library_comment = markup.get_selected_library_comment()
    discussionable.get(<span class="hljs-string">'authable'</span>).<span class="hljs-keyword">then</span> (authable) =&gt;
      options = 
        <span class="hljs-attribute">value</span>:          value
        <span class="hljs-attribute">authable</span>:       authable
        <span class="hljs-attribute">ownerable</span>:      <span class="hljs-property">@totem_scope</span>.get_ownerable_record()
        <span class="hljs-attribute">creatorable</span>:    <span class="hljs-property">@totem_scope</span>.get_current_user()
        <span class="hljs-attribute">discussionable</span>: discussionable
      options.save = <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> library_comment <span class="hljs-comment"># We want to persist the discussion since there will be no explicit comment save.</span>
      markup.add_discussion(options).<span class="hljs-keyword">then</span> (discussion) =&gt;
        <span class="hljs-keyword">if</span> library_comment
          options = 
            <span class="hljs-attribute">commenterable</span>: <span class="hljs-property">@totem_scope</span>.get_current_user()
            <span class="hljs-attribute">library_comment</span>: library_comment
          markup.reset_selected_library_comment()
          markup.add_comment_to_discussion(discussion, options)
        <span class="hljs-keyword">else</span>
          options = {<span class="hljs-attribute">commenterable</span>: <span class="hljs-property">@totem_scope</span>.get_current_user()}
          markup.add_comment_to_discussion_and_edit(discussion, options)


  <span class="hljs-attribute">get_$file_container</span>: <span class="hljs-function">-&gt;</span>
    container_id = <span class="hljs-property">@get</span> <span class="hljs-string">'file_container_id'</span>
    $(<span class="hljs-string">'#'</span> + container_id)

  <span class="hljs-attribute">load_and_show_pdf</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@get</span> <span class="hljs-string">'show_file'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span>     <span class="hljs-property">@get</span> <span class="hljs-string">'is_loaded'</span>
    model = <span class="hljs-property">@get</span> <span class="hljs-string">'model'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ID used to identify the container in the format of: artifact-file-pdf-container-#{artifact-model.id}
Get the div rendered by the template which is a container for the PDF renderer.</p></div></div><div class="code"><div class="wrapper">    $container = <span class="hljs-property">@get_$file_container</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> $container.length &lt; <span class="hljs-number">1</span>  <span class="hljs-comment"># if show_file is initially true, the show_file observer will call before the container is rendered (didInsertElement will re-call)</span>
    width            = <span class="hljs-number">960</span>  <span class="hljs-comment"># could set different if 'comment_section' is null</span>
    PDFJS.workerSrc  = <span class="hljs-property">@get</span>(<span class="hljs-string">'pdf_worker_src'</span>)
    PDFJS.cMapUrl    = <span class="hljs-string">'cmaps/'</span>
    PDFJS.cMapPacked = <span class="hljs-literal">true</span>
    
    <span class="hljs-property">@get</span>(<span class="hljs-string">'markup'</span>).set_is_pdf_loading()
    PDFJS.getDocument(<span class="hljs-property">@get</span> <span class="hljs-string">'file_url'</span>).<span class="hljs-keyword">then</span> (pdf) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the first page and setup rendering options.</p></div></div><div class="code"><div class="wrapper">      pdf.getPage(<span class="hljs-number">1</span>).<span class="hljs-keyword">then</span> (page) =&gt;
        options =
          <span class="hljs-attribute">pdf</span>:              pdf
          <span class="hljs-attribute">num_pages</span>:        pdf.numPages
          <span class="hljs-attribute">num_current_page</span>: <span class="hljs-number">1</span>
          <span class="hljs-attribute">container</span>:        $container
          <span class="hljs-attribute">scale</span>:            <span class="hljs-number">1</span>
          <span class="hljs-attribute">width</span>:            width
        <span class="hljs-property">@render_page</span>(page, options)

  <span class="hljs-attribute">render_page</span>: <span class="hljs-function"><span class="hljs-params">(page, options)</span> -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a canvas element and append it to the PDF container.
=&gt; Then, call this function again for each page.</p></div></div><div class="code"><div class="wrapper">    scale     = options.scale
    container = options.container
    num_pages = options.num_pages
    pdf       = options.pdf
    width     = options.width</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Scale width to a given pixel size if specified.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> width?
      viewport = page.getViewport(<span class="hljs-number">1</span>)
      scale    = width / viewport.width
    viewport       = page.getViewport(scale)
    canvas         = $(<span class="hljs-string">'&lt;canvas&gt;&lt;/canvas&gt;'</span>).attr(<span class="hljs-string">'height'</span>, viewport.height).attr(<span class="hljs-string">'width'</span>, viewport.width).attr(<span class="hljs-string">'page'</span>, options.num_current_page)
    context        = canvas.get(<span class="hljs-number">0</span>).getContext(<span class="hljs-string">'2d'</span>) <span class="hljs-comment"># getContext is a DOM object function, not a jQuery function.</span>
    render_context = 
      <span class="hljs-attribute">canvasContext</span>: context
      <span class="hljs-attribute">viewport</span>:      viewport
    page.render(render_context)
    container.append(canvas)
    <span class="hljs-property">@get</span>(<span class="hljs-string">'rendered_canvases'</span>).pushObject(canvas)
    options.num_current_page += <span class="hljs-number">1</span>
    num_current_page          = options.num_current_page
    <span class="hljs-keyword">if</span> num_current_page &lt;= num_pages <span class="hljs-keyword">and</span> pdf
      pdf.getPage(num_current_page).<span class="hljs-keyword">then</span> (page) =&gt;
        <span class="hljs-property">@render_page</span>(page, options)
    <span class="hljs-keyword">else</span>
      markup = <span class="hljs-property">@get</span> <span class="hljs-string">'markup'</span>
      model  = <span class="hljs-property">@get</span> <span class="hljs-string">'model'</span>
      markup.set_is_pdf()
      markup.set_is_pdf_loaded()</div></div></div></div></body></html>