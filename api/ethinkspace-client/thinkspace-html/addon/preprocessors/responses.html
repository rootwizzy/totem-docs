<!DOCTYPE html><html lang="en"><head><title>thinkspace-html/addon/preprocessors/responses</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="thinkspace-html/addon/preprocessors/responses"><meta name="groc-project-path" content="thinkspace-html/addon/preprocessors/responses.coffee"><meta name="groc-branch-path" content="feature/rap-analytics-styling"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-client"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-client/blob/feature/rap-analytics-styling/thinkspace-html/addon/preprocessors/responses.coffee">thinkspace-html/addon/preprocessors/responses.coffee</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper">import ember  from <span class="hljs-string">'ember'</span>
import util   from <span class="hljs-string">'totem/util'</span>
import ns     from <span class="hljs-string">'totem/ns'</span>
import totem_changeset from <span class="hljs-string">'totem/changeset'</span>
import totem_scope     from <span class="hljs-string">'totem/scope'</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> tvo is set when this preprocessor is created.</span></p>
<p>Process input and textarea tags and replace with components.</p></div></div><div class="code"><div class="wrapper">export default ember.Object.extend

  <span class="hljs-attribute">process</span>: <span class="hljs-function"><span class="hljs-params">(componentable, template)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      <span class="hljs-keyword">return</span> resolve(template) <span class="hljs-keyword">unless</span> (componentable <span class="hljs-keyword">and</span> template)

      componentable.get(ns.to_p <span class="hljs-string">'elements'</span>).<span class="hljs-keyword">then</span> (elements) =&gt;
        <span class="hljs-keyword">return</span> resolve(template)  <span class="hljs-keyword">if</span> ember.isBlank(elements)
        $content    = ember.$(<span class="hljs-string">'&lt;div/&gt;'</span>).html(template)
        root_path   = <span class="hljs-property">@get</span>(<span class="hljs-string">'input_element_root_path'</span>)
        prefix      = <span class="hljs-property">@get</span>(<span class="hljs-string">'input_element_component_prefix'</span>)

        <span class="hljs-property">@get_ownerable_responses</span>(componentable, elements).<span class="hljs-keyword">then</span> (responses) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The html content contains a html string with input tags.  This view generator
replaces the input tags with handlebars &#39;componet&#39; for the responses.</p></div></div><div class="code"><div class="wrapper">          elements.forEach (element, index) =&gt;
            response   = responses.objectAt(index)
            input_name = element.get <span class="hljs-string">'name'</span>

            <span class="hljs-keyword">return</span> reject(<span class="hljs-string">"Componentable id [<span class="hljs-subst">#{componentable.get(<span class="hljs-string">'id'</span>)}</span>] input element id [<span class="hljs-subst">#{element.get(<span class="hljs-string">'id'</span>)}</span>] is blank"</span>) <span class="hljs-keyword">unless</span> input_name</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Specify input possibilities here otherwise collision with carry forward is possible.</p></div></div><div class="code"><div class="wrapper">            $input = $content.find(<span class="hljs-string">"input[name=<span class="hljs-subst">#{input_name}</span>]"</span>)
            $input = $content.find(<span class="hljs-string">"textarea[name=<span class="hljs-subst">#{input_name}</span>]"</span>) <span class="hljs-keyword">unless</span> ember.isPresent($input)
            <span class="hljs-keyword">return</span> resolve() <span class="hljs-keyword">unless</span> $input
            <span class="hljs-keyword">return</span> reject(<span class="hljs-string">"Componentable id [<span class="hljs-subst">#{componentable.get(<span class="hljs-string">'id'</span>)}</span>] tool_content is missing input element name [<span class="hljs-subst">#{input_name}</span>]"</span>) <span class="hljs-keyword">unless</span> $input.length &gt; <span class="hljs-number">0</span>

            tag_kind   = <span class="hljs-property">@tvo</span>.tag_kind($input)
            tag_type   = <span class="hljs-property">@tvo</span>.tag_type($input)
            attributes = <span class="hljs-property">@tvo</span>.tag_attribute_hash($input)

            <span class="hljs-keyword">if</span> <span class="hljs-property">@is_checkbox</span>(tag_type)
              attributes.disabled = <span class="hljs-literal">true</span>  <span class="hljs-keyword">if</span> <span class="hljs-property">@is_viewonly</span>()
            <span class="hljs-keyword">else</span>
              attributes.disabled = <span class="hljs-literal">true</span>  <span class="hljs-keyword">if</span> <span class="hljs-property">@is_disabled</span>()
              attributes.readonly = <span class="hljs-literal">true</span>  <span class="hljs-keyword">if</span> <span class="hljs-property">@is_readonly</span>()

            <span class="hljs-keyword">unless</span> response
              response  = <span class="hljs-property">@tc</span>.create_record ns.to_p(<span class="hljs-string">'response'</span>), <span class="hljs-attribute">value</span>: <span class="hljs-literal">null</span>
              response.set ns.to_p(<span class="hljs-string">'element'</span>), element
              totem_scope.set_record_ownerable_attributes(response)
              response.didLoad()

            changeset = <span class="hljs-property">@get_changeset</span>(response, tag_type)
            <span class="hljs-property">@tvo</span>.status.register_changeset(changeset, <span class="hljs-attribute">key</span>: <span class="hljs-property">@results_key</span>) <span class="hljs-keyword">unless</span> <span class="hljs-property">@is_checkbox</span>(tag_type)

            hash           = {}
            hash.tattrs    = attributes
            hash.changeset = changeset

            path = <span class="hljs-property">@tvo</span>.value.set_value_for element, hash

            html = []
            html.push <span class="hljs-string">"tvo.<span class="hljs-subst">#{path}</span>.component"</span>
            html.push <span class="hljs-property">@tvo</span>.component_bind_properties(path, hash)
            hash.component   = <span class="hljs-string">"<span class="hljs-subst">#{root_path}</span>/<span class="hljs-subst">#{prefix}</span>_<span class="hljs-subst">#{<span class="hljs-property">@get_input_component_name</span>(tag_kind, tag_type)}</span>"</span>

            attribute_query   = <span class="hljs-string">"<span class="hljs-subst">#{tag_kind}</span>[name='<span class="hljs-subst">#{input_name}</span>']"</span>
            attribute_matches = $content.find(attribute_query)
            util.error @, <span class="hljs-string">"No attribute match found for find on <span class="hljs-subst">#{attribute_query}</span> against: <span class="hljs-subst">#{$content.html()}</span>"</span> <span class="hljs-keyword">if</span> attribute_matches.length == <span class="hljs-number">0</span>

            <span class="hljs-keyword">if</span> <span class="hljs-property">@is_radio</span>(tag_type)
              attribute_matches.each (index, input_match) =&gt;
                last    = ((index + <span class="hljs-number">1</span>) == attribute_matches.length)
                $radio  = $(input_match)
                value   = $radio.attr(<span class="hljs-string">'value'</span>)
                $parent = $radio.parent() <span class="hljs-keyword">if</span> last
                <span class="hljs-keyword">if</span> value?
                  comp = [<span class="hljs-string">"radio_value='<span class="hljs-subst">#{value}</span>'"</span>, <span class="hljs-string">"radio_last=<span class="hljs-subst">#{last}</span>"</span>]
                  $radio.replaceWith <span class="hljs-property">@get_component_html</span>(html.concat comp)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If is the last radio button, add the errors component.</p></div></div><div class="code"><div class="wrapper">                  $parent.append(<span class="hljs-string">"{{component '<span class="hljs-subst">#{root_path}</span>/standard_radio_errors' changeset=tvo.<span class="hljs-subst">#{path}</span>.changeset}}"</span>) <span class="hljs-keyword">if</span> last
                <span class="hljs-keyword">else</span>
                  util.error @, <span class="hljs-string">"Radio button <span class="hljs-subst">#{input_match}</span> does not have a value attribute."</span>
            <span class="hljs-keyword">else</span>
              util.warn @, <span class="hljs-string">"Possible mass-replacement of an InputElement due to multiple matches for <span class="hljs-subst">#{attribute_query}</span>"</span> <span class="hljs-keyword">if</span> attribute_matches.length &gt; <span class="hljs-number">1</span>
              attribute_matches.replaceWith <span class="hljs-property">@get_component_html</span>(html)

          <span class="hljs-property">@get</span>(<span class="hljs-string">'tvo.status'</span>).update(<span class="hljs-attribute">key</span>: <span class="hljs-property">@results_key</span>)

          resolve $content.html()

  <span class="hljs-attribute">get_component_html</span>: <span class="hljs-function"><span class="hljs-params">(html)</span> -&gt;</span> <span class="hljs-string">'{{component '</span> + html.join(<span class="hljs-string">' '</span>) + <span class="hljs-string">'}}'</span>

  <span class="hljs-attribute">is_text</span>:     <span class="hljs-function"><span class="hljs-params">(tag_type)</span> -&gt;</span> tag_type == <span class="hljs-string">'text'</span>
  <span class="hljs-attribute">is_radio</span>:    <span class="hljs-function"><span class="hljs-params">(tag_type)</span> -&gt;</span> tag_type == <span class="hljs-string">'radio'</span>
  <span class="hljs-attribute">is_checkbox</span>: <span class="hljs-function"><span class="hljs-params">(tag_type)</span> -&gt;</span> tag_type == <span class="hljs-string">'checkbox'</span>

  <span class="hljs-attribute">is_viewonly</span>: <span class="hljs-function">-&gt;</span> totem_scope.get(<span class="hljs-string">'is_view_only'</span>)
  <span class="hljs-attribute">is_readonly</span>: <span class="hljs-function">-&gt;</span> totem_scope.get(<span class="hljs-string">'is_read_only'</span>)
  <span class="hljs-attribute">is_disabled</span>: <span class="hljs-function">-&gt;</span> totem_scope.get(<span class="hljs-string">'is_disabled'</span>)

  <span class="hljs-attribute">get_input_component_name</span>: <span class="hljs-function"><span class="hljs-params">(tag_kind, tag_type)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> tag_kind
      <span class="hljs-keyword">when</span> <span class="hljs-string">'input'</span>
        <span class="hljs-keyword">switch</span>
          <span class="hljs-keyword">when</span> <span class="hljs-property">@is_checkbox</span>(tag_type) <span class="hljs-keyword">then</span> <span class="hljs-string">'checkbox'</span>
          <span class="hljs-keyword">when</span> <span class="hljs-property">@is_radio</span>(tag_type)    <span class="hljs-keyword">then</span> <span class="hljs-string">'radio'</span>
          <span class="hljs-keyword">else</span> <span class="hljs-string">'input'</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'textarea'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'textarea'</span>
      <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

  <span class="hljs-attribute">get_ownerable_responses</span>: <span class="hljs-function"><span class="hljs-params">(componentable, elements)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      <span class="hljs-property">@tc</span>.view_load(componentable).<span class="hljs-keyword">then</span> =&gt;
        promises = elements.getEach(<span class="hljs-string">'response'</span>)
        ember.RSVP.Promise.all(promises).<span class="hljs-keyword">then</span> (records) =&gt;
          resolve(records)
        , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> reject(error)
      , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> reject(error)
    , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> reject(error)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hard coded validation rules - need a way to persist the appropriate validation rules per input element.
Validations are added to the actual model (e.g. user response).</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-attribute">get_changeset</span>: <span class="hljs-function"><span class="hljs-params">(response, tag_type)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> totem_changeset.no_validation(response) <span class="hljs-keyword">if</span> <span class="hljs-property">@is_checkbox</span>(tag_type)
    message    = <span class="hljs-keyword">if</span> <span class="hljs-property">@is_radio</span>(tag_type) <span class="hljs-keyword">then</span> <span class="hljs-string">'You must select one of the above choices'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'You must enter a response'</span>
    validators = []
    validators.push totem_changeset.vpresence(<span class="hljs-attribute">presence</span>: <span class="hljs-literal">true</span>, <span class="hljs-attribute">message</span>: message)
    totem_changeset.create response, <span class="hljs-attribute">value</span>: validators

  <span class="hljs-attribute">toString</span>: <span class="hljs-function">-&gt;</span> <span class="hljs-string">'HTMLResponsePreprocessor'</span></div></div></div></div></body></html>