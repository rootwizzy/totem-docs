<!DOCTYPE html><html lang="en"><head><title>thinkspace-html/addon/preprocessors/carry_forward</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="thinkspace-html/addon/preprocessors/carry_forward"><meta name="groc-project-path" content="thinkspace-html/addon/preprocessors/carry_forward.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">thinkspace-html/addon/preprocessors/carry_forward.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">import ember from <span class="hljs-string">'ember'</span>
import ns    from <span class="hljs-string">'totem/ns'</span>
import ajax  from <span class="hljs-string">'totem/ajax'</span>
import totem_scope from <span class="hljs-string">'totem/scope'</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> tvo is set when this preprocessor is created.</span></p>
<p>Process carry forward tags e.g. <thinkspace type="carry_forward" name="some_input_tag_name"></thinkspace></p></div></div><div class="code"><div class="wrapper">export default ember.Object.extend

  <span class="hljs-attribute">process</span>: <span class="hljs-function"><span class="hljs-params">(componentable, template)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      <span class="hljs-keyword">return</span> resolve(template) <span class="hljs-keyword">unless</span> (componentable <span class="hljs-keyword">and</span> template)
      <span class="hljs-property">@process_carry_forward_tags</span>(componentable, template).<span class="hljs-keyword">then</span> (template) =&gt;
        resolve(template)

  <span class="hljs-attribute">process_carry_forward_tags</span>: <span class="hljs-function"><span class="hljs-params">(componentable, template)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      $content = ember.$(<span class="hljs-string">'&lt;div/&gt;'</span>).html(template)
      $tags    = $content.find(<span class="hljs-string">'thinkspace[type=carry_forward]'</span>)
      <span class="hljs-keyword">return</span> resolve(template)  <span class="hljs-keyword">if</span> $tags.length &lt; <span class="hljs-number">1</span>

      root_path = <span class="hljs-property">@get</span>(<span class="hljs-string">'input_element_root_path'</span>)
      prefix    = <span class="hljs-property">@get</span>(<span class="hljs-string">'input_element_component_prefix'</span>)
      type      = ns.to_p <span class="hljs-string">'response'</span>
<span class="hljs-function">      <span class="hljs-title">names</span>     = <span class="hljs-params">($tags.map (index, tag) -&gt; $(tag).attr(<span class="hljs-string">'name'</span>))</span>.<span class="hljs-title">toArray</span><span class="hljs-params">()</span>

      @<span class="hljs-title">get_carry_forward_responses_from_server</span><span class="hljs-params">(names)</span>.<span class="hljs-title">then</span> <span class="hljs-params">(payload)</span> =&gt;</span>

        response_ids = (payload[<span class="hljs-string">'data'</span>] <span class="hljs-keyword">or</span> []).mapBy(<span class="hljs-string">'id'</span>)
        <span class="hljs-property">@tc</span>.push_payload(payload)
        responses = []
        <span class="hljs-keyword">for</span> id <span class="hljs-keyword">in</span> response_ids
          response = <span class="hljs-property">@tc</span>.peek_record(type, id)
          responses.push(response) <span class="hljs-keyword">if</span> response

        c_path   = <span class="hljs-string">"<span class="hljs-subst">#{root_path}</span>/<span class="hljs-subst">#{prefix}</span>_carry_forward"</span>
        name_map = payload[<span class="hljs-string">'element_map'</span>] <span class="hljs-keyword">or</span> {}

        $tags.each (index, tag) =&gt;
          $tag          = $(tag)
          name          = $tag.attr(<span class="hljs-string">'name'</span>)
          ids           = name_map[name] <span class="hljs-keyword">or</span> []
          tag_responses = responses.filter (response) =&gt; ids.includes parseInt(response.get <span class="hljs-string">'id'</span>)

          hash =
            <span class="hljs-attribute">component_name</span>: c_path
            <span class="hljs-attribute">responses</span>:      tag_responses
            <span class="hljs-attribute">element_name</span>:   name

          value_path = <span class="hljs-property">@tvo</span>.value.set_value hash

          html = <span class="hljs-string">'{{ component'</span>
          html += <span class="hljs-string">" tvo.<span class="hljs-subst">#{value_path}</span>.component_name"</span>
          html += <span class="hljs-string">" responses=tvo.<span class="hljs-subst">#{value_path}</span>.responses"</span>
          html += <span class="hljs-string">" element_name=tvo.<span class="hljs-subst">#{value_path}</span>.element_name"</span>
          html += <span class="hljs-string">' }}'</span>

          $tag.replaceWith(html)

        resolve $content.html()

      , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> reject(error)

  <span class="hljs-attribute">get_carry_forward_responses_from_server</span>: <span class="hljs-function"><span class="hljs-params">(names)</span> -&gt;</span>
    <span class="hljs-keyword">new</span> ember.RSVP.Promise (resolve, reject) =&gt;
      query =
        <span class="hljs-attribute">verb</span>:   <span class="hljs-string">'post'</span>
        <span class="hljs-attribute">action</span>: <span class="hljs-string">'carry_forward'</span>
        <span class="hljs-attribute">model</span>:  ns.to_p <span class="hljs-string">'response'</span>
        <span class="hljs-attribute">data</span>:
          <span class="hljs-attribute">element_names</span>: names
      totem_scope.add_ownerable_to_query(query.data)
      totem_scope.add_authable_to_query(query.data)
      ajax.object(query).<span class="hljs-keyword">then</span> (payload) =&gt;
        resolve(payload)
      , <span class="hljs-function"><span class="hljs-params">(error)</span> =&gt;</span> reject(error)</div></div></div></div></body></html>