<!DOCTYPE html><html lang="en"><head><title>thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/forecast_actuals</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../../"><meta name="groc-document-path" content="thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/forecast_actuals"><meta name="groc-project-path" content="thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/forecast_actuals.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../../../../assets/style.css"><script type="text/javascript" src="../../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/forecast_actuals.rb">thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/forecast_actuals.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">require</span> <span class="hljs-string">'open-uri'</span>

<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">WeatherForecaster</span></span>
    <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">AutoScore</span></span>

      <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ForecastActuals</span></span>
        
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:run_options</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:current_station_code</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:loaded_actuals</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(options={})</span></span>
          <span class="hljs-variable">@run_options</span>    = options
          <span class="hljs-variable">@loaded_actuals</span> = <span class="hljs-constant">Array</span>.new
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          raise_error <span class="hljs-string">"Forecast day is blank."</span>  <span class="hljs-keyword">if</span> forecast_day.blank?
          raise_error <span class="hljs-string">"Station id is blank."</span>    <span class="hljs-keyword">if</span> station_id.blank?
          raise_error <span class="hljs-string">"Forecast day should be an instance of forecast day not <span class="hljs-subst">#{forecast_day.<span class="hljs-keyword">class</span>.name.inspect}</span>."</span> <span class="hljs-keyword">unless</span> forecast_day.is_a?(forecast_day_class)
          reload? ? reload_actuals_from_file(forecast_day, station_id) <span class="hljs-symbol">:</span> get_forecast_day_actuals(forecast_day, station_id)
        <span class="hljs-keyword">end</span>

        private

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reload_actuals_from_file</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          has_been_loaded?(forecast_day, station_id) ? get_forecast_day_actuals(forecast_day, station_id) <span class="hljs-symbol">:</span> load_actuals_from_file(forecast_day, station_id)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_forecast_day_actuals</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          forecast_day_actual = get_forecast_day_actual(forecast_day, station_id)
          forecast_day_actual.present? ? forecast_day_actual <span class="hljs-symbol">:</span> load_actuals_from_url(forecast_day, station_id)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_actuals_from_url</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          station = station_class.find_by(<span class="hljs-symbol">id:</span> station_id)
          raise_error <span class="hljs-string">"Station id <span class="hljs-subst">#{station_id}</span> not found."</span>  <span class="hljs-keyword">if</span> station.blank?
          url     = get_url_for_forecast_day(forecast_day)
          debug_message <span class="hljs-string">"Loading actuals from URL [<span class="hljs-subst">#{url}</span>] for <span class="hljs-subst">#{forecast_day.forecast_at.to_date.to_s(<span class="hljs-symbol">:db</span>)}</span> and station <span class="hljs-subst">#{station.location.inspect}</span>"</span>  <span class="hljs-keyword">if</span> debug? &amp;&amp; !has_been_loaded?(forecast_day, station_id)
          <span class="hljs-keyword">begin</span>
            content = open(url).read
          <span class="hljs-keyword">rescue</span> <span class="hljs-constant">OpenURI::HTTPError</span> =&gt; e
            raise_error <span class="hljs-string">"The requested URL [<span class="hljs-subst">#{url}</span>] was not found on the server."</span>
          <span class="hljs-keyword">end</span>
          actuals, original = get_actuals_for_day_and_station(content, forecast_day, station)
          raise_error <span class="hljs-string">"Station <span class="hljs-subst">#{station.location.inspect}</span> id <span class="hljs-subst">#{station.id}</span> not found in actuals URL [<span class="hljs-subst">#{url}</span>]"</span>  <span class="hljs-keyword">if</span> actuals.blank?
          update_or_create_forecast_day_actual(forecast_day, station_id, actuals, original)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_actuals_from_file</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          station = station_class.find_by(<span class="hljs-symbol">id:</span> station_id)
          raise_error <span class="hljs-string">"Station id <span class="hljs-subst">#{station_id}</span> not found."</span>  <span class="hljs-keyword">if</span> station.blank?
          file_path = get_file_path_for_forecast_day(forecast_day)
          raise_error   <span class="hljs-string">"File at path <span class="hljs-subst">#{file_path.inspect}</span> not found."</span>  <span class="hljs-keyword">unless</span> <span class="hljs-constant">File</span>.file?(file_path)
          debug_message <span class="hljs-string">"Loading actuals from file <span class="hljs-subst">#{file_path.inspect}</span> for <span class="hljs-subst">#{forecast_day.forecast_at.to_date.to_s(<span class="hljs-symbol">:db</span>)}</span> and station <span class="hljs-subst">#{station.location.inspect}</span>"</span>  <span class="hljs-keyword">if</span> debug? &amp;&amp; !has_been_loaded?(forecast_day, station_id)
          actuals, original = get_actuals_for_day_and_station(<span class="hljs-constant">File</span>.read(file_path), forecast_day, station)
          raise_error <span class="hljs-string">"Station <span class="hljs-subst">#{station.location.inspect}</span> id <span class="hljs-subst">#{station.id}</span> not found in actuals file <span class="hljs-subst">#{file_path.inspect}</span>."</span>  <span class="hljs-keyword">if</span> actuals.blank?
          update_or_create_forecast_day_actual(forecast_day, station_id, actuals, original)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_file_path_for_forecast_day</span><span class="hljs-params">(forecast_day)</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: need to determine how and where to get this information</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="testing-only">TESTING ONLY</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">          filename  = <span class="hljs-string">'test_file_'</span>
          filename += (forecast_day.id % <span class="hljs-number">3</span>).to_s
          filename += <span class="hljs-string">'.txt'</span>
          <span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.root, <span class="hljs-string">"../../forecasting/<span class="hljs-subst">#{filename}</span>"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="testing-only">TESTING ONLY</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_url_for_forecast_day</span><span class="hljs-params">(forecast_day)</span></span>
          forecast_at = forecast_day.forecast_at
          raise_error <span class="hljs-string">"Forecast day [<span class="hljs-subst">#{forecast_day.id}</span>] does not have a forecast_at."</span> <span class="hljs-keyword">unless</span> forecast_at.present?
          date     = forecast_at.strftime(<span class="hljs-string">'%Y%m%d'</span>)
          base_url = <span class="hljs-string">'http://mtarchive.geol.iastate.edu/fcst/'</span>
          url      = base_url + date + <span class="hljs-string">'.out'</span>
          debug_message <span class="hljs-string">"Found URL for date as: <span class="hljs-subst">#{url}</span>"</span> <span class="hljs-keyword">if</span> debug?
          url
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_or_create_forecast_day_actual</span><span class="hljs-params">(forecast_day, station_id, actuals, original)</span></span>
          forecast_day_actual = get_forecast_day_actual(forecast_day, station_id)
          <span class="hljs-keyword">if</span> forecast_day_actual.blank?
            forecast_day_actual = forecast_day_actual_class.get_new_record(forecast_day.id, station_id)
          <span class="hljs-keyword">end</span>
          forecast_day_actual.value    = actuals
          forecast_day_actual.original = original
          <span class="hljs-keyword">return</span> forecast_day_actual  <span class="hljs-keyword">if</span> dry_run?
          raise_error <span class="hljs-string">"Could not save forecast day actual <span class="hljs-subst">#{forecast_day_actual.inspect}</span>."</span>  <span class="hljs-keyword">unless</span> forecast_day_actual.save
          forecast_day_actual
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_been_loaded?</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          loaded = [forecast_day.id, station_id]
          <span class="hljs-keyword">if</span> loaded_actuals.<span class="hljs-keyword">include</span>?(loaded)
            <span class="hljs-keyword">true</span>
          <span class="hljs-keyword">else</span>
            loaded_actuals.push(loaded)
            <span class="hljs-keyword">false</span>
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="read-and-parse-actuals-file">Read and Parse Actuals File.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_actuals_for_day_and_station</span><span class="hljs-params">(content, forecast_day, station)</span></span>
          <span class="hljs-variable">@current_station_code</span> = station.location.downcase
          original              = <span class="hljs-string">''</span>
          collect               = <span class="hljs-keyword">false</span>
          content.each_line <span class="hljs-keyword">do</span> |line|
            <span class="hljs-keyword">if</span> line.strip.match(<span class="hljs-regexp">/^station=/i</span>)
              station, code = line.chomp.split(<span class="hljs-string">'='</span>,<span class="hljs-number">2</span>)
              collect       = (code.downcase == current_station_code)
              original     += line <span class="hljs-keyword">if</span> collect
            <span class="hljs-keyword">else</span>
              <span class="hljs-keyword">if</span> collect
                original += line
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">break</span>  <span class="hljs-keyword">if</span> original.present?
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">end</span>
          raise_code_error <span class="hljs-string">"did not have values in content."</span>  <span class="hljs-keyword">if</span> original.blank?
          [convert_station_code_values(original), original]
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_station_code_values</span><span class="hljs-params">(original)</span></span>
          actuals = <span class="hljs-constant">Hash</span>.new
          original.each_line <span class="hljs-keyword">do</span> |oline|
            line = oline.chomp.strip
            <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> line.match(<span class="hljs-regexp">/^station=/i</span>)
            var, value = line.split(<span class="hljs-string">'='</span>,<span class="hljs-number">2</span>)
            var   = var.strip   <span class="hljs-keyword">if</span> var.present?
            value = value.strip <span class="hljs-keyword">if</span> value.present?
            raise_code_error <span class="hljs-string">"has an invalid 'variable=value' format <span class="hljs-subst">#{line.inspect}</span>."</span>  <span class="hljs-keyword">unless</span> var.present? &amp;&amp; value.present?
            raise_code_error <span class="hljs-string">"has duplicate variable <span class="hljs-subst">#{var.inspect}</span>."</span>  <span class="hljs-keyword">if</span> actuals.has_key?(var)
            actuals[var] = parse_variable_value(value)
          <span class="hljs-keyword">end</span>
          actuals
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_variable_value</span><span class="hljs-params">(value)</span></span>
          error_message = <span class="hljs-string">"has an invalid variable range format <span class="hljs-subst">#{value.inspect}</span>."</span>
          logic         = <span class="hljs-keyword">nil</span>
          actual        = <span class="hljs-keyword">nil</span>
          <span class="hljs-keyword">case</span>
          <span class="hljs-keyword">when</span> is_integer?(value)
            logic  = <span class="hljs-symbol">:equal</span>
            actual = value
          <span class="hljs-keyword">when</span> value.match(<span class="hljs-string">','</span>)
            logic  = <span class="hljs-symbol">:and</span>
            actual = value.split(<span class="hljs-string">','</span>).map {|v| v.strip}
            raise_code_error error_message  <span class="hljs-keyword">if</span> actual.find {|v| v.blank?}
          <span class="hljs-keyword">when</span> value.match(<span class="hljs-string">':'</span>)
            logic    = <span class="hljs-symbol">:range</span>
            min, max = value.split(<span class="hljs-string">':'</span>).map {|v| v.strip}
            raise_code_error error_message  <span class="hljs-keyword">if</span> min.blank? || max.blank?
            raise_code_error error_message + <span class="hljs-string">"  Minimum value not an integer."</span>  <span class="hljs-keyword">unless</span> is_integer?(min)
            raise_code_error error_message + <span class="hljs-string">"  Maximum value not an integer."</span>  <span class="hljs-keyword">unless</span> is_integer?(max)
            raise_code_error error_message + <span class="hljs-string">"  Mimimum value greater then maximum value."</span>  <span class="hljs-keyword">if</span> min.to_i &gt; max.to_i
            actual = {<span class="hljs-symbol">min:</span> min, <span class="hljs-symbol">max:</span> max}
          <span class="hljs-keyword">when</span> value.match(<span class="hljs-string">'|'</span>)
            logic  = <span class="hljs-symbol">:or</span>
            actual = value.split(<span class="hljs-string">'|'</span>).map {|v| v.strip}
            raise_code_error error_message  <span class="hljs-keyword">if</span> actual.find {|v| v.blank?}
          <span class="hljs-keyword">end</span>
          raise_code_error error_message  <span class="hljs-keyword">if</span> logic.blank? || actual.blank?
          {<span class="hljs-symbol">logic:</span> logic, <span class="hljs-symbol">actual:</span> actual}
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="helpers">Helpers.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_forecast_day_actual</span><span class="hljs-params">(forecast_day, station_id)</span></span>
          forecast_day_actual_class.scope_by_forecast_day_id_and_station_id(forecast_day.id, station_id)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_integer?</span><span class="hljs-params">(value)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> value.blank?
          value.to_s.match(<span class="hljs-regexp">/^[-|+]?\d+$/</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reload?</span>;</span>    run_options[<span class="hljs-symbol">:reload_actuals</span>].present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dry_run?</span>;</span>   run_options[<span class="hljs-symbol">:dry_run</span>].present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug?</span>;</span>     run_options[<span class="hljs-symbol">:debug</span>].present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">quiet?</span>;</span>     run_options[<span class="hljs-symbol">:quiet</span>].present?; <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">station_class</span>;</span>             <span class="hljs-constant">Thinkspace::WeatherForecaster::Station</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forecast_day_class</span>;</span>        <span class="hljs-constant">Thinkspace::WeatherForecaster::ForecastDay</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forecast_day_actual_class</span>;</span> <span class="hljs-constant">Thinkspace::WeatherForecaster::ForecastDayActual</span>; <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug_message</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          puts message
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="raise-errors">Raise Errors.</h3>
<h2 id="">#</h2>
<p>AutoScore::Process rescues from specific error classes.  Raise them if passed in the initialize options.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">raise_code_error</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          raise_error <span class="hljs-string">"Station code <span class="hljs-subst">#{current_station_code.inspect}</span> "</span> + message
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">raise_non_fatal_error</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          error_class = run_options[<span class="hljs-symbol">:non_fatal_error_class</span>] || run_options[<span class="hljs-symbol">:error_class</span>] || <span class="hljs-constant">ProcessError</span>
          raise error_class, message
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">raise_error</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          error_class = run_options[<span class="hljs-symbol">:error_class</span>] || <span class="hljs-constant">ProcessError</span>
          raise error_class, message
        <span class="hljs-keyword">end</span>

        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessError</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">StandardError</span></span>;</span> <span class="hljs-keyword">end</span>

      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></div></div></div></div></body></html>