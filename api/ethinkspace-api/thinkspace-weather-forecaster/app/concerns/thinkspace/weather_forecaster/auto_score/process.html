<!DOCTYPE html><html lang="en"><head><title>thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/process</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../../"><meta name="groc-document-path" content="thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/process"><meta name="groc-project-path" content="thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/process.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../../../../assets/style.css"><script type="text/javascript" src="../../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/process.rb">thinkspace-weather-forecaster/app/concerns/thinkspace/weather_forecaster/auto_score/process.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">WeatherForecaster</span></span>
    <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">AutoScore</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Auto score forecast respones.
See documentation at end of this file or run a rake task with [help].</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Process</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>scopes</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:scope_assessments</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:scope_forecasts</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:scope_assessment_items</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:scope_responses</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>extract args</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:arg_str</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:arg_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:arg_days</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:arg_rake_task</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ids</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:assessment_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:station_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:forecast_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:item_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:assessment_item_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:response_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:authable_ids</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:authable_class</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>misc</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:actual_forecast_days</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:station_codes</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:assessment_ids_scope_message</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>boolean related options</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:rescore</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:reload_actuals</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:default_days</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:show_help</span>
        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:debug</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span></span>
          <span class="hljs-variable">@verify</span>          = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@quiet</span>           = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@dry_run</span>         = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@print_ids</span>       = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@show_help</span>       = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@rescore</span>         = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@reload_actuals</span>  = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@debug</span>           = <span class="hljs-keyword">false</span>
          <span class="hljs-variable">@max_days</span>        = <span class="hljs-number">7</span>
          <span class="hljs-variable">@default_days</span>    = <span class="hljs-string">'days:1'</span>
          <span class="hljs-variable">@num_responses</span>   = <span class="hljs-number">0</span>
          <span class="hljs-variable">@total_responses</span> = <span class="hljs-number">0</span>
          <span class="hljs-variable">@station_ids</span>     = <span class="hljs-constant">Array</span>.new
          <span class="hljs-variable">@station_codes</span>   = <span class="hljs-constant">Array</span>.new
          <span class="hljs-variable">@scope_responses</span> = response_class.all
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="public-methods">Public Methods.</h3>
<h2 id="">#</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="assessments">Assessments.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_assessments</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
          set_assessment_ids_for_assessments(args)
          process
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="forecasts">Forecasts.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_forecasts</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
          set_assessment_ids_for_forecasts(args)
          process_assessments
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="items">Items.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_items</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
          set_assessment_ids_for_items(args)
          process_assessments
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="assessment-items">Assessment Items.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_assessment_items</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
          set_assessment_ids_for_assessment_items(args)
          process_assessments
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="responses">Responses.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_responses</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
          set_assessment_ids_for_responses(args)
          process_assessments
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="authables">Authables.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_authables</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
          set_assessment_ids_for_authable(args)
          process_assessments
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="private-methods">Private Methods.</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">        private

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span></span>
          forecast_days = get_forecast_days(arg_days)
          print_run_values
          set_final_run_scopes
          process_forecast_days(forecast_days)
          print_total_responses
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_final_run_scopes</span></span>
          <span class="hljs-variable">@scope_assessments</span> = assessment_class.all  <span class="hljs-keyword">if</span> scope_assessments.blank?
          <span class="hljs-variable">@scope_forecasts</span>   = forecast_class.all    <span class="hljs-keyword">if</span> scope_forecasts.blank?
          <span class="hljs-keyword">if</span> rescore?
            <span class="hljs-variable">@scope_assessments</span> = scope_assessments.to_rescore
            <span class="hljs-variable">@scope_forecasts</span>   = scope_forecasts.to_rescore
            confirm_rescore
          <span class="hljs-keyword">else</span>
            <span class="hljs-variable">@scope_assessments</span> = scope_assessments.to_score
            <span class="hljs-variable">@scope_forecasts</span>   = scope_forecasts.to_score
          <span class="hljs-keyword">end</span>
          <span class="hljs-variable">@scope_assessments</span> = scope_assessments.where(<span class="hljs-symbol">id:</span> assessment_ids)       <span class="hljs-keyword">if</span> assessment_ids.present?
          <span class="hljs-variable">@scope_assessments</span> = scope_assessments.where(<span class="hljs-symbol">station_id:</span> station_ids)  <span class="hljs-keyword">if</span> station_ids.present?
          stop_run <span class="hljs-string">"No assessments found with the run values."</span>  <span class="hljs-keyword">if</span> scope_assessments.blank?
          <span class="hljs-variable">@scope_forecasts</span> = scope_forecasts.where(<span class="hljs-symbol">id:</span> forecast_ids)  <span class="hljs-keyword">if</span> forecast_ids.present?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_forecast_days</span><span class="hljs-params">(forecast_days)</span></span>
          assessment_class.transaction <span class="hljs-keyword">do</span>
            <span class="hljs-keyword">begin</span>
              assessments = scope_assessments.order(<span class="hljs-symbol">:station_id</span>)
              forecast_days.each <span class="hljs-keyword">do</span> |forecast_day|
                print_value(forecast_day_class.name, forecast_day.forecast_at.to_date.to_s(<span class="hljs-symbol">:db</span>), <span class="hljs-string">''</span>)
                assessments.each <span class="hljs-keyword">do</span> |assessment|
                  forecast_day_actual = forecast_actuals_instance.process(forecast_day, assessment.station_id)
                  forecasts           = scope_forecasts.where(<span class="hljs-symbol">assessment_id:</span> assessment.id, <span class="hljs-symbol">forecast_day_id:</span> forecast_day.id)
                  auto_score_forecasts(forecasts, forecast_day_actual)
                <span class="hljs-keyword">end</span>
                print_count(assessment_class, assessments)
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">rescue</span> <span class="hljs-constant">ProcessError</span>, <span class="hljs-constant">ProcessNonFatalError</span> =&gt; e
              <span class="hljs-keyword">if</span> e.is_a?(<span class="hljs-constant">ProcessNonFatalError</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Continue processing the next forecast (currently all errors are: ProcessError).</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">else</span>
                raise e  <span class="hljs-comment"># Re-raising the error to rollback db updates.</span>
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">end</span> <span class="hljs-comment"># transaction</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_forecast_days</span><span class="hljs-params">(days)</span></span>
          forecast_days = forecast_day_class.scope_by_days(days)
          <span class="hljs-keyword">if</span> forecast_days.blank?
            print_run_values
            stop_run <span class="hljs-string">"No forecasts were submitted in the days selected."</span>
          <span class="hljs-keyword">end</span>
          <span class="hljs-variable">@actual_forecast_days</span> = forecast_days.map(&amp;<span class="hljs-symbol">:forecast_at</span>).sort  <span class="hljs-keyword">if</span> forecast_days.length != days.length
          forecast_days
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<h2 id="">#</h2>
<h3 id="auto-score-forecasts">Auto-score Forecasts.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">auto_score_forecasts</span><span class="hljs-params">(forecasts, forecast_day_actual)</span></span>
          <span class="hljs-variable">@num_responses</span> = <span class="hljs-number">0</span>
          forecasts.each <span class="hljs-keyword">do</span> |forecast|
            <span class="hljs-keyword">begin</span>
              forecast.transaction <span class="hljs-keyword">do</span>
                responses = scope_responses.where(<span class="hljs-symbol">forecast_id:</span> forecast.id)
                auto_score_responses(responses, forecast_day_actual)
                update_forecast(forecast)
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">rescue</span> <span class="hljs-constant">ProcessError</span>, <span class="hljs-constant">ProcessNonFatalError</span> =&gt; e
              <span class="hljs-keyword">if</span> e.is_a?(<span class="hljs-constant">ProcessNonFatalError</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Continue processing the next forecast (currently all errors are: ProcessError).</p></div></div><div class="code"><div class="wrapper">              <span class="hljs-keyword">else</span>
                raise e  <span class="hljs-comment"># Re-raising the error to rollback db updates.</span>
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">end</span>
          print_count(forecast_class, forecasts, <span class="hljs-string">"  (responses: <span class="hljs-subst">#{<span class="hljs-variable">@num_responses</span>}</span>)"</span>)
          <span class="hljs-variable">@total_responses</span> += <span class="hljs-variable">@num_responses</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_forecast</span><span class="hljs-params">(forecast)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> dry_run?
          forecast.set_locked
          forecast.score = forecast.sum_response_scores
          raise <span class="hljs-constant">ProcessError</span>, <span class="hljs-string">"Error saving forecast <span class="hljs-subst">#{forecast.inspect}</span>."</span>  <span class="hljs-keyword">unless</span> forecast.save
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">auto_score_responses</span><span class="hljs-params">(responses, forecast_day_actual)</span></span>
          responses.each <span class="hljs-keyword">do</span> |response|
            score_response(response, forecast_day_actual)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">score_response</span><span class="hljs-params">(response, forecast_day_actual)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> response.blank?
          <span class="hljs-variable">@num_responses</span> += <span class="hljs-number">1</span>
          score = response.calculate_score(common_instance_initialize_options.merge(<span class="hljs-symbol">forecast_day_actual:</span> forecast_day_actual))
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> dry_run?
          response_score = response.find_or_create_response_score
          raise <span class="hljs-constant">ProcessError</span>, <span class="hljs-string">"Response [id: <span class="hljs-subst">#{response.id}</span>] response score is blank."</span> <span class="hljs-keyword">if</span> response_score.blank?
          response_score.score = score
          raise <span class="hljs-constant">ProcessError</span>, <span class="hljs-string">"Error saving response score [id: <span class="hljs-subst">#{response_score.id}</span>]."</span> <span class="hljs-keyword">unless</span> response_score.save
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="scopes-and-set-assessment-ids">Scopes and set Assessment Ids.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_assessment_ids_for_assessments</span><span class="hljs-params">(args)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> assessment_ids.present?  <span class="hljs-comment"># args extracted and set via another rake task e.g. forecasts, items, etc.</span>
          extract_and_validate_args(assessment_class, args)
          <span class="hljs-variable">@assessment_ids</span>               = arg_ids
          <span class="hljs-variable">@assessment_ids_scope_message</span> = <span class="hljs-string">'all assessments'</span>  <span class="hljs-keyword">if</span> assessment_ids.blank?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_assessment_ids_for_forecasts</span><span class="hljs-params">(args)</span></span>
          extract_and_validate_args(forecast_class, args)
          <span class="hljs-variable">@forecast_ids</span> = arg_ids
          scope         = forecast_ids.present? ? forecast_class.where(<span class="hljs-symbol">id:</span> forecast_ids) <span class="hljs-symbol">:</span> forecast_class.all
          scope         = scope.scope_by_days(arg_days)  <span class="hljs-keyword">if</span> arg_days.present?
          <span class="hljs-keyword">if</span> scope.blank?
            print_run_values
            stop_run <span class="hljs-string">"No forecasts found for the run values."</span>
          <span class="hljs-keyword">end</span>
          <span class="hljs-variable">@assessment_ids</span> = scope.pluck(<span class="hljs-symbol">:assessment_id</span>).uniq
          stop_run <span class="hljs-string">"No assessments found for forecast ids: <span class="hljs-subst">#{forecast_ids}</span>."</span>  <span class="hljs-keyword">if</span> assessment_ids.blank?
          <span class="hljs-variable">@assessment_ids_scope_message</span> = <span class="hljs-string">'all forecast assessments'</span>     <span class="hljs-keyword">if</span> forecast_ids.blank?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_assessment_ids_for_items</span><span class="hljs-params">(args)</span></span>
          extract_and_validate_args(item_class, args)
          <span class="hljs-variable">@item_ids</span>            = arg_ids
          <span class="hljs-variable">@assessment_item_ids</span> = assessment_item_class.where(<span class="hljs-symbol">item_id:</span> arg_ids).pluck(<span class="hljs-symbol">:id</span>).uniq
          <span class="hljs-variable">@assessment_ids</span>      = assessment_class.scope_by_assessment_item_ids(assessment_item_ids).pluck(<span class="hljs-symbol">:id</span>).uniq
          stop_run <span class="hljs-string">"No assessments found for item ids: <span class="hljs-subst">#{item_ids}</span> -&gt; assessment item ids: <span class="hljs-subst">#{assessment_item_ids}</span>."</span>  <span class="hljs-keyword">if</span> assessment_ids.blank?
          <span class="hljs-variable">@scope_responses</span> = scope_responses.where(<span class="hljs-symbol">assessment_item_id:</span> assessment_item_ids)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_assessment_ids_for_assessment_items</span><span class="hljs-params">(args)</span></span>
          extract_and_validate_args(assessment_item_class, args)
          <span class="hljs-variable">@assessment_item_ids</span> = arg_ids
          <span class="hljs-variable">@assessment_ids</span>      = assessment_class.scope_by_assessment_item_ids(assessment_item_ids).pluck(<span class="hljs-symbol">:id</span>).uniq
          stop_run <span class="hljs-string">"No assessments found for assessment item ids: <span class="hljs-subst">#{assessment_item_ids}</span>."</span>  <span class="hljs-keyword">if</span> assessment_ids.blank?
          <span class="hljs-variable">@scope_responses</span> = scope_responses.where(<span class="hljs-symbol">assessment_item_id:</span> assessment_item_ids)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_assessment_ids_for_responses</span><span class="hljs-params">(args)</span></span>
          extract_and_validate_args(response_class, args)
          <span class="hljs-variable">@response_ids</span> = arg_ids
          stop_run <span class="hljs-string">"Response ids blank."</span>  <span class="hljs-keyword">if</span> response_ids.blank?
          <span class="hljs-variable">@scope_responses</span> = scope_responses.where(<span class="hljs-symbol">id:</span> response_ids)
          <span class="hljs-variable">@assessment_item_ids</span> = scope_responses.pluck(<span class="hljs-symbol">:assessment_item_id</span>).uniq
          stop_run <span class="hljs-string">"No assessment items found for response ids: <span class="hljs-subst">#{response_ids}</span>."</span>  <span class="hljs-keyword">if</span> assessment_item_ids.blank?
          <span class="hljs-variable">@assessment_ids</span> = assessment_class.scope_by_assessment_item_ids(assessment_item_ids).pluck(<span class="hljs-symbol">:id</span>).uniq
          stop_run <span class="hljs-string">"No assessments found for response ids: <span class="hljs-subst">#{response_ids}</span>."</span>  <span class="hljs-keyword">if</span> assessment_ids.blank?
          <span class="hljs-variable">@forecast_ids</span> = forecast_class.scope_by_response_ids(response_ids).pluck(<span class="hljs-symbol">:id</span>).uniq
          stop_run <span class="hljs-string">"No forecasts found for response ids: <span class="hljs-subst">#{response_ids}</span>."</span>  <span class="hljs-keyword">if</span> forecast_ids.blank?
          <span class="hljs-variable">@scope_forecasts</span> = forecast_class.where(<span class="hljs-symbol">id:</span> forecast_ids)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_assessment_ids_for_authable</span><span class="hljs-params">(args)</span></span>
          args          = [args].flatten
          authable_type = args.shift
          stop_run <span class="hljs-string">"Authable class is blank. Provide the class path or string as the first argument."</span>  <span class="hljs-keyword">if</span> authable_type.blank?
          <span class="hljs-variable">@authable_class</span> = authable_type.classify.safe_constantize
          stop_run <span class="hljs-string">"Authable type <span class="hljs-subst">#{authable_type.inspect}</span> could not be constantized."</span>  <span class="hljs-keyword">if</span> authable_class.blank?
          extract_and_validate_args(authable_class, args)
          <span class="hljs-variable">@authable_ids</span>   = arg_ids
          <span class="hljs-variable">@assessment_ids</span> = assessment_class.where(<span class="hljs-symbol">authable_type:</span> authable_class.name, <span class="hljs-symbol">authable_id:</span> authable_ids).pluck(<span class="hljs-symbol">:id</span>).uniq
          stop_run <span class="hljs-string">"No assessments found for authable <span class="hljs-subst">#{authable_class.name}</span> ids: <span class="hljs-subst">#{authable_ids}</span>."</span>  <span class="hljs-keyword">if</span> assessment_ids.blank?
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="helper-class-instances">Helper Class Instances.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forecast_actuals_instance</span></span>
          <span class="hljs-variable">@forecast_actual_instance</span> ||= <span class="hljs-constant">AutoScore::ForecastActuals</span>.new(common_instance_initialize_options)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">common_instance_initialize_options</span></span>
          <span class="hljs-variable">@common_instance_initialize_options</span> ||= {
            <span class="hljs-symbol">reload_actuals:</span>        reload_actuals?,
            <span class="hljs-symbol">dry_run:</span>               dry_run?,
            <span class="hljs-symbol">debug:</span>                 debug?,
            <span class="hljs-symbol">quiet:</span>                 quiet?,
            <span class="hljs-symbol">error_class:</span>           <span class="hljs-constant">ProcessError</span>,
            <span class="hljs-symbol">non_fatal_error_class:</span> <span class="hljs-constant">ProcessNonFatalError</span>,
          }
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="extract-args">Extract Args.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_and_validate_args</span><span class="hljs-params">(klass, args)</span></span>
          <span class="hljs-variable">@arg_rake_task</span> = klass.name.demodulize.downcase.pluralize
          args = [args].flatten.compact.collect {|v| v.strip}
          <span class="hljs-keyword">if</span> args.blank?
            <span class="hljs-variable">@arg_days</span> = validate_dates_into_day_times(default_days) <span class="hljs-keyword">if</span> arg_days.blank?
            <span class="hljs-keyword">return</span>
          <span class="hljs-keyword">end</span>
          <span class="hljs-variable">@arg_str</span>   = args.join(<span class="hljs-string">','</span>)
          ids, dates = get_ids_and_dates(args)
          dates      = dates.push(default_days) <span class="hljs-keyword">if</span> dates.blank?
          <span class="hljs-variable">@arg_ids</span>   = validate_ids(klass, ids)
          <span class="hljs-variable">@arg_days</span>  = validate_dates_into_day_times(dates)
          <span class="hljs-keyword">if</span> arg_days.length &gt; <span class="hljs-variable">@max_days</span>
            message  = <span class="hljs-string">"The number days selected (<span class="hljs-subst">#{arg_days.length}</span>) is over the maximum allowed of <span class="hljs-subst">#{<span class="hljs-variable">@max_days</span>}</span>."</span>
            message += <span class="hljs-string">"  If the number of days is correct, use the arg 'max_days:#' to override."</span>
            stop_run message
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_ids_and_dates</span><span class="hljs-params">(args)</span></span>
          ids   = <span class="hljs-constant">Array</span>.new
          dates = <span class="hljs-constant">Array</span>.new
          args.each <span class="hljs-keyword">do</span> |arg|
            arg = arg.to_s
            <span class="hljs-keyword">case</span>
            <span class="hljs-keyword">when</span> is_digits?(arg)               <span class="hljs-keyword">then</span> ids.push(arg.to_i)
            <span class="hljs-keyword">when</span> arg.match(<span class="hljs-regexp">/\d+-\d+-\d+/</span>)      <span class="hljs-keyword">then</span> dates.push(arg)
            <span class="hljs-keyword">when</span> arg.start_with?(<span class="hljs-string">'days:'</span>)      <span class="hljs-keyword">then</span> dates.push(arg)
            <span class="hljs-keyword">when</span> arg == <span class="hljs-string">'day'</span>                  <span class="hljs-keyword">then</span> dates.push(<span class="hljs-string">'days:1'</span>)
            <span class="hljs-keyword">else</span>
              stop_run <span class="hljs-string">"Invalid argument <span class="hljs-subst">#{arg.inspect}</span>."</span>  <span class="hljs-keyword">unless</span> valid_run_option_arg(arg)
            <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">end</span>
          [ids, dates]
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">valid_run_option_arg</span><span class="hljs-params">(arg)</span></span>
          <span class="hljs-keyword">case</span> arg.downcase
            <span class="hljs-keyword">when</span> <span class="hljs-string">'rescore'</span>                        <span class="hljs-keyword">then</span> <span class="hljs-variable">@rescore</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'verify'</span>, <span class="hljs-string">'v'</span>                    <span class="hljs-keyword">then</span> <span class="hljs-variable">@verify</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'quiet'</span>, <span class="hljs-string">'q'</span>                     <span class="hljs-keyword">then</span> <span class="hljs-variable">@quiet</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'dry_run'</span>, <span class="hljs-string">'dry-run'</span>, <span class="hljs-string">'d'</span>        <span class="hljs-keyword">then</span> <span class="hljs-variable">@dry_run</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'print_ids'</span>, <span class="hljs-string">'print-ids'</span>, <span class="hljs-string">'p'</span>    <span class="hljs-keyword">then</span> <span class="hljs-variable">@print_ids</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'debug'</span>                          <span class="hljs-keyword">then</span> <span class="hljs-variable">@debug</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'reload_actuals'</span>                 <span class="hljs-keyword">then</span> <span class="hljs-variable">@reload_actuals</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'help'</span>, <span class="hljs-string">'h'</span>                      <span class="hljs-keyword">then</span> <span class="hljs-variable">@show_help</span> = <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">else</span>
              <span class="hljs-keyword">case</span>
              <span class="hljs-keyword">when</span> arg.start_with?(<span class="hljs-string">'max_days:'</span>) || arg.start_with?(<span class="hljs-string">'max-days:'</span>) || arg.start_with?(<span class="hljs-string">'m:'</span>)
                days = get_arg_value(arg) || <span class="hljs-string">''</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span> <span class="hljs-keyword">unless</span> is_digits?(days)
                <span class="hljs-variable">@max_days</span> = days.to_i
              <span class="hljs-keyword">when</span> arg.start_with?(<span class="hljs-string">'station:'</span>)
                code = get_arg_value(arg) || <span class="hljs-string">''</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span> <span class="hljs-keyword">unless</span> code.length == <span class="hljs-number">4</span> &amp;&amp; code.match(<span class="hljs-regexp">/^\w+$/</span>)
                add_station_id(code)
              <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">false</span>
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_ids</span><span class="hljs-params">(klass, ids)</span></span>
          ids.each <span class="hljs-keyword">do</span> |id|
            record = klass.find_by(<span class="hljs-symbol">id:</span> id)
            stop_run <span class="hljs-string">"Record '<span class="hljs-subst">#{klass.name}</span> id:<span class="hljs-subst">#{id}</span>' not found."</span>  <span class="hljs-keyword">if</span> record.blank?
          <span class="hljs-keyword">end</span>
          ids
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_dates_into_day_times</span><span class="hljs-params">(dates)</span></span>
          days = <span class="hljs-constant">Array</span>.new
          [dates].flatten.each <span class="hljs-keyword">do</span> |date|
            days.push convert_date_value(date)
          <span class="hljs-keyword">end</span>
          [days].flatten.compact.uniq.sort
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date_value</span><span class="hljs-params">(date)</span></span>
          <span class="hljs-keyword">case</span>
          <span class="hljs-keyword">when</span> date.start_with?(<span class="hljs-string">'days:'</span>)
            t, days = date.split(<span class="hljs-string">':'</span>,<span class="hljs-number">2</span>)
            stop_run <span class="hljs-string">"Number of days in <span class="hljs-subst">#{date.inspect}</span> is not numeric."</span>  <span class="hljs-keyword">unless</span> days.match(<span class="hljs-regexp">/^\d+$/</span>)
            start_date = get_current_day - days.to_i.days
            end_date   = get_current_day - <span class="hljs-number">1</span>.day
            get_days_between_dates(start_date.to_s, end_date.to_s)
          <span class="hljs-keyword">when</span> date.end_with?(<span class="hljs-string">':'</span>)
            end_date = get_current_day - <span class="hljs-number">1</span>.day
            get_days_between_dates(date, end_date.to_s)
          <span class="hljs-keyword">when</span> date.match(<span class="hljs-string">':'</span>)
            start_date, end_date = date.split(<span class="hljs-string">':'</span>,<span class="hljs-number">2</span>)
            get_days_between_dates(start_date, end_date)
          <span class="hljs-keyword">else</span>
            get_time_from_date_string(date)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_current_day</span>;</span> forecast_day_class.get_current_day; <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_days_between_dates</span><span class="hljs-params">(start_date, end_date)</span></span>
          all_days   = <span class="hljs-constant">Array</span>.new
          start_date = get_time_from_date_string(start_date)
          end_date   = get_time_from_date_string(end_date)
          stop_run <span class="hljs-string">"Starting date <span class="hljs-subst">#{start_date.to_date.inspect}</span> greater than end date <span class="hljs-subst">#{end_date.to_date.inspect}</span>."</span>  <span class="hljs-keyword">if</span> start_date &gt; end_date
          days = end_date.to_date - start_date.to_date
          days += <span class="hljs-number">1</span> <span class="hljs-comment"># include the end date</span>
          days.to_i.times <span class="hljs-keyword">do</span> |i|
            all_days.push start_date + i.days
          <span class="hljs-keyword">end</span>
          all_days
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_time_from_date_string</span><span class="hljs-params">(date)</span></span>
          <span class="hljs-keyword">begin</span>
            time = <span class="hljs-constant">Time</span>.parse(date)
          <span class="hljs-keyword">rescue</span> <span class="hljs-constant">ArgumentError</span>
            stop_run <span class="hljs-string">"Invalid date <span class="hljs-subst">#{date.inspect}</span>.  Must be in format 'YYYY-MM-DD'."</span>
          <span class="hljs-keyword">end</span>
          forecast_day_class.get_day(time)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_station_id</span><span class="hljs-params">(code)</span></span>
          station = station_class.where(<span class="hljs-string">'LOWER(location) = ?'</span>, code.downcase)
          stop_run <span class="hljs-string">"Station location <span class="hljs-subst">#{code.inspect}</span> not found (case insensitive search)."</span> <span class="hljs-keyword">if</span> station.blank?
          stop_run <span class="hljs-string">"Station location <span class="hljs-subst">#{code.inspect}</span> returned <span class="hljs-subst">#{station.length}</span> stations (case insensitive search)."</span> <span class="hljs-keyword">if</span> station.length != <span class="hljs-number">1</span>
          station = station.first
          station_ids.push(station.id)
          station_codes.push(station.location)
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="helpers">Helpers.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_arg_value</span><span class="hljs-params">(arg)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> arg.blank?
          arg.split(<span class="hljs-string">':'</span>,<span class="hljs-number">2</span>).last
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_digits?</span><span class="hljs-params">(arg)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> arg.blank?
          arg.match(<span class="hljs-regexp">/^\d+$/</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_run_values</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> quiet?
          puts <span class="hljs-string">"\nRun values:"</span>
          puts <span class="hljs-string">'   This is a DRY RUN!'</span>  <span class="hljs-keyword">if</span> dry_run?
          puts <span class="hljs-string">'   Run is a RESCORE!'</span>   <span class="hljs-keyword">if</span> rescore?
          print_value <span class="hljs-string">'Rake task'</span>,                 (arg_rake_task || <span class="hljs-string">''</span>).inspect, <span class="hljs-string">''</span>
          print_value <span class="hljs-string">'Argument string'</span>,           (arg_str || <span class="hljs-string">''</span>).inspect, <span class="hljs-string">''</span>
          print_value assessment_class.name,       assessment_ids_scope_message || assessment_ids
          print_value forecast_class.name,         forecast_ids
          print_value item_class.name,             item_ids
          print_value assessment_item_class.name,  assessment_item_ids
          print_value response_class.name,         response_ids
          print_value authable_class.name,         authable_ids  <span class="hljs-keyword">if</span> authable_class.present?
          print_value station_class.name,          station_codes, <span class="hljs-string">'.location'</span>
          print_value <span class="hljs-string">'Selected forecast days'</span>,    (arg_days || []).map {|d| d.to_date.to_s(<span class="hljs-symbol">:db</span>)}, <span class="hljs-string">''</span>
          print_value <span class="hljs-string">'Actual days with forecsts'</span>, actual_forecast_days.map {|d| d.to_date.to_s(<span class="hljs-symbol">:db</span>)}, <span class="hljs-string">''</span>  <span class="hljs-keyword">if</span> actual_forecast_days.present?
          puts <span class="hljs-string">''</span>
          <span class="hljs-keyword">if</span> show_help
            print_help
            stop_run
          <span class="hljs-keyword">end</span>
          ask_yes <span class="hljs-string">'Continue with these run values?'</span>  <span class="hljs-keyword">if</span> verify? &amp;&amp; !rescore?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_value</span><span class="hljs-params">(text, values, sub_text=<span class="hljs-string">'.id'</span>, post_text=<span class="hljs-string">''</span>)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> values.blank?
          len = <span class="hljs-number">56</span>
          puts <span class="hljs-string">"   <span class="hljs-subst">#{text}</span><span class="hljs-subst">#{sub_text}</span>"</span>.ljust(len) + <span class="hljs-string">": <span class="hljs-subst">#{values}</span>"</span> + post_text
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_count</span><span class="hljs-params">(klass, array, text=<span class="hljs-string">''</span>)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> quiet?
          name = klass.name
          <span class="hljs-keyword">if</span> print_ids? &amp;&amp; array.length &gt; <span class="hljs-number">0</span>
            ids  = array.map(&amp;<span class="hljs-symbol">:id</span>)
            text = text.ljust(<span class="hljs-number">20</span>)  <span class="hljs-keyword">if</span> text.present?
            text += <span class="hljs-string">"  ids: <span class="hljs-subst">#{ids}</span>"</span>
          <span class="hljs-keyword">end</span>
          count   = array.length.to_s.rjust(<span class="hljs-number">5</span>)
          message = <span class="hljs-string">"   <span class="hljs-subst">#{name}</span>"</span>.ljust(<span class="hljs-number">55</span>) + <span class="hljs-string">' ids-count: '</span> + count + text
          puts message
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_total_responses</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> quiet?
          puts <span class="hljs-string">"Total responses processed: <span class="hljs-subst">#{<span class="hljs-variable">@total_responses</span>}</span>"</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">confirm_rescore</span></span>
          ask_yes <span class="hljs-string">"\nDo you really want to perform a 'rescore' with these run values?"</span> <span class="hljs-keyword">if</span> verify?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ask_yes</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          puts message + <span class="hljs-string">' (yes/no)'</span>
          answer = <span class="hljs-constant">STDIN</span>.gets.chomp
          stop_run <span class="hljs-keyword">unless</span> (answer.present? &amp;&amp; answer.downcase == <span class="hljs-string">'yes'</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop_run</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          puts <span class="hljs-string">"\n"</span>
          puts <span class="hljs-string">"&gt;&gt; Run stopped [<span class="hljs-subst">#{<span class="hljs-constant">Time</span>.now.to_s(<span class="hljs-symbol">:db</span>)}</span>]. "</span> + message
          puts <span class="hljs-string">"\n"</span>
          exit
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">quiet?</span>;</span>            <span class="hljs-variable">@quiet</span>.present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">verify?</span>;</span>           <span class="hljs-variable">@verify</span>.present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_ids?</span>;</span>        <span class="hljs-variable">@print_ids</span>.present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dry_run?</span>;</span>          <span class="hljs-variable">@dry_run</span>.present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rescore?</span>;</span>          <span class="hljs-variable">@rescore</span>.present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reload_actuals?</span>;</span>   <span class="hljs-variable">@reload_actuals</span>.present?; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug?</span>;</span>            <span class="hljs-variable">@debug</span>.present?; <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">item_class</span>;</span>                <span class="hljs-constant">Thinkspace::WeatherForecaster::Item</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forecast_day_class</span>;</span>        <span class="hljs-constant">Thinkspace::WeatherForecaster::ForecastDay</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">assessment_class</span>;</span>          <span class="hljs-constant">Thinkspace::WeatherForecaster::Assessment</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">assessment_item_class</span>;</span>     <span class="hljs-constant">Thinkspace::WeatherForecaster::AssessmentItem</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forecast_class</span>;</span>            <span class="hljs-constant">Thinkspace::WeatherForecaster::Forecast</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">response_class</span>;</span>            <span class="hljs-constant">Thinkspace::WeatherForecaster::Response</span>; <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">station_class</span>;</span>             <span class="hljs-constant">Thinkspace::WeatherForecaster::Station</span>; <span class="hljs-keyword">end</span>

        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessError</span>         <span class="hljs-inheritance">&lt; <span class="hljs-parent">StandardError</span></span>;</span> <span class="hljs-keyword">end</span>
        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessNonFatalError</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">StandardError</span></span>;</span> <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="help-doc">Help Doc.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_help</span></span>
          help = &lt;&lt;<span class="hljs-constant">HELP</span>
<span class="hljs-constant">Run</span> <span class="hljs-symbol">help:</span>
  <span class="hljs-constant">CAUTION</span><span class="hljs-symbol">:</span> <span class="hljs-constant">FOR</span> <span class="hljs-constant">RAKE</span> <span class="hljs-constant">TASKS</span>, <span class="hljs-constant">NO</span> <span class="hljs-constant">SPACES</span> <span class="hljs-constant">ARE</span> <span class="hljs-constant">ALLOWED</span> <span class="hljs-constant">BETWEEN</span> <span class="hljs-constant">ARGUMENTS</span>  <span class="hljs-symbol">right:</span> [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]  <span class="hljs-symbol">wrong:</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]

  <span class="hljs-constant">Overview</span><span class="hljs-symbol">:</span>
    <span class="hljs-constant">Every</span> run scopes the assessments <span class="hljs-keyword">and</span> forecasts according to the run values.  <span class="hljs-constant">If</span> use a rake task other <span class="hljs-keyword">then</span>
    <span class="hljs-string">'assessments'</span> <span class="hljs-keyword">or</span> <span class="hljs-string">'forecasts'</span>, the task model will also be scoped e.g. item.id == <span class="hljs-number">1</span>.

  <span class="hljs-constant">Rake</span> task <span class="hljs-symbol">options:</span>
    * options can be <span class="hljs-keyword">in</span> any order <span class="hljs-keyword">in</span> the argument string (execpt authables where the <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">path</span> <span class="hljs-title">must</span> <span class="hljs-title">be</span> <span class="hljs-title">the</span> <span class="hljs-title">first</span> <span class="hljs-title">argument</span>)</span>
    [<span class="hljs-comment">#,#,...]:              : record ids for the main run class e.g assessments, forecasts, authables, etc.</span>
    [<span class="hljs-constant">YYYY</span>-<span class="hljs-constant">MM</span>-<span class="hljs-constant">DD</span>]            <span class="hljs-symbol">:</span> day to scope the forecasts
    [<span class="hljs-constant">YYYY</span>-<span class="hljs-constant">MM</span>-<span class="hljs-constant">DD</span><span class="hljs-symbol">:</span>]           <span class="hljs-symbol">:</span> e.g. date ending <span class="hljs-keyword">in</span> a colon; days calculated by start day up to <span class="hljs-keyword">and</span> including the current day
    [<span class="hljs-constant">YYYY</span>-<span class="hljs-constant">MM</span>-<span class="hljs-constant">DD</span><span class="hljs-symbol">:YYYY-MM-DD</span>] <span class="hljs-symbol">:</span> day ranage including the start day <span class="hljs-keyword">and</span> <span class="hljs-keyword">end</span> day
    [day]                   <span class="hljs-symbol">:</span> previous day before the current day (<span class="hljs-keyword">alias</span> <span class="hljs-keyword">for</span> <span class="hljs-string">'days:1'</span>)
    [<span class="hljs-symbol">days:</span><span class="hljs-comment">#]                : (default #{default_days.inspect}) number of days before the current day</span>

    <span class="hljs-constant">WARNING</span><span class="hljs-symbol">:</span> <span class="hljs-constant">If</span> a date <span class="hljs-keyword">or</span> date-range is used, the current day will be scored <span class="hljs-keyword">if</span> the current day is <span class="hljs-keyword">in</span> the range (<span class="hljs-keyword">or</span> date is the current day).
             <span class="hljs-constant">Use</span> <span class="hljs-string">'days:#'</span> type argument to make sure the current day is <span class="hljs-keyword">not</span> included.

    [<span class="hljs-symbol">max_days:</span><span class="hljs-comment">#|max-days:#|m:#] : (default #{<span class="hljs-doctag">@max</span>_days}); to help prevent a typeo, the number of days selected is checked against the max days allowed</span>
                                <span class="hljs-symbol">:</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">if</span> over the maximum the run is stopped
                                <span class="hljs-symbol">:</span> <span class="hljs-constant">If</span> you know the run will be over the default, override the max days with this option.

    [<span class="hljs-symbol">station:</span>code]              <span class="hljs-symbol">:</span> scope the assessments to the station code (four character/number station location)
                                <span class="hljs-symbol">:</span> can be used multiple times e.g. [<span class="hljs-symbol">station:</span>abcd,<span class="hljs-symbol">station:</span>wxyz]

    <span class="hljs-constant">Boolean</span> options (default <span class="hljs-keyword">false</span>)<span class="hljs-symbol">:</span>           
      [rescore]               <span class="hljs-symbol">:</span> use the rescore scopes e.g. forecast state <span class="hljs-string">'locked'</span>
      [reload_actuals]        <span class="hljs-symbol">:</span> reload <span class="hljs-keyword">and</span> update/create the forecast day actuals from a file e.g. updates the actuals <span class="hljs-keyword">if</span> already exist
                                (by default, they are only created <span class="hljs-keyword">when</span> a forecast_day_actual record does <span class="hljs-keyword">not</span> exist)
      [verify|v]              <span class="hljs-symbol">:</span> prompt to verify the run values
      [quiet|q]               <span class="hljs-symbol">:</span> <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> print any status information
      [print_ids|print-ids|p] <span class="hljs-symbol">:</span> print a list of ids after the status message
      [dry_run|dry-run|d]     <span class="hljs-symbol">:</span> perform a dry run
      [debug]                 <span class="hljs-symbol">:</span> set debug on; mainly <span class="hljs-keyword">for</span> the <span class="hljs-constant">AutoScore::Response</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>

  <span class="hljs-constant">Tasks</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>assessments       <span class="hljs-comment">#=&gt; all assessments unless ids present; date options are applied to the forecasts</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>forecasts         <span class="hljs-comment">#=&gt; all forecasts unless ids present</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>items             <span class="hljs-comment">#=&gt; item ids -&gt; assessment item ids (for all forecasts) to score</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>assessment_items  <span class="hljs-comment">#=&gt; assessment item ids to score</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>authables         <span class="hljs-comment">#=&gt; authable ids used to find assessment ids to score</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>phases            <span class="hljs-comment">#=&gt; alias for authables by passing in the phase class path</span>
    <span class="hljs-symbol">thinkspace:</span><span class="hljs-symbol">weather_forecaster:</span><span class="hljs-symbol">score:</span>responses         <span class="hljs-comment">#=&gt; score specific response ids (very narrow scope; id(s) must also be in the day scope)</span>

  <span class="hljs-constant">Tasks</span><span class="hljs-symbol">:</span> assessments vs forecasts
    <span class="hljs-constant">No</span> difference between running tasks <span class="hljs-string">'assessments'</span> vs <span class="hljs-string">'forecasts'</span> <span class="hljs-keyword">unless</span> want to specifiy ids.
    <span class="hljs-constant">Ids</span> <span class="hljs-keyword">for</span> the <span class="hljs-string">'assessments'</span> task will scope the assessment ids, <span class="hljs-keyword">while</span> ids <span class="hljs-keyword">for</span> the <span class="hljs-string">'forecasts'</span> task scopes forecast ids.

    <span class="hljs-constant">However</span>, other tasks (items, assessment_items, authables, phases, responses) <span class="hljs-keyword">require</span> an <span class="hljs-constant">ID</span> to scope the assessments <span class="hljs-keyword">and</span> forecasts.

  <span class="hljs-constant">Forecast</span> states (<span class="hljs-symbol">scopes:</span> <span class="hljs-string">'to_score'</span> vs <span class="hljs-string">'to_rescore):
    * '</span>to_score<span class="hljs-string">'   : scoped to state='</span>completed<span class="hljs-string">'              (no rescore option)
    * '</span>to_rescore<span class="hljs-string">' : scoped to state='</span>completed<span class="hljs-string">' or '</span>locked<span class="hljs-string">'  (with rescore option)
    * state='</span>unlocked<span class="hljs-string">' (e.g. not submitted), are not scored.

  Examples:

   rake thinkspace:weather_forecaster:score:asessments         #=&gt; score all assessments and forecasts for the previous day
   rake thinkspace:weather_forecaster:score:asessments[day]    #=&gt; same as above
   rake thinkspace:weather_forecaster:score:asessments[days:1] #=&gt; same as above
   rake thinkspace:weather_forecaster:score:forecasts          #=&gt; all forecasts for the previous day

    thinkspace:weather_forecaster:score:assessments[rescore]        #=&gt; rescore all assessment forecasts
   rake thinkspace:weather_forecaster:score:assessments[1,days:2]   #=&gt; score the forecasts for '</span>assessment<span class="hljs-string">' id 1 for the previous 2 days
   rake thinkspace:weather_forecaster:score:forecasts[1,days:2]     #=&gt; score the forecasts for '</span>forecast<span class="hljs-string">' id 1 for the previous 2 days

   rake thinkspace:weather_forecaster:score:assessments[2015-06-01]             #=&gt; score forecasts for 2015-06-01
   rake thinkspace:weather_forecaster:score:assessments[2015-06-01:]            #=&gt; score forecasts for 2015-06-01 through (current-day - 1.day)
   rake thinkspace:weather_forecaster:score:assessments[2015-06-01:2015-06-03]  #=&gt; score forecasts for 2015-06-01, 2015-06-02, 2015-06-03

   rake thinkspace:weather_forecaster:score:authables[thinspace/casespace/phase,1] #=&gt; get the assessment id(s) related to phase id 1 and process
                                                                                       the assessments for the previous day
   rake thinkspace:weather_forecaster:score:phases[1] #=&gt; same as above

  Ids and boolean options can be anywhere in the argument string.
   rake thinkspace:weather_forecaster:score:assessments[1,p,d,days:2,9,verify]
     * score the forecasts for assessment ids [1, 9] for the previous 2 days (in a completed state)
     * perform a dry run; verify run values before processing; print the ids

  Running Real-Time (e.g. via UI)
   The arguments for each public method is an array of values (e.g. [1, 2, '</span><span class="hljs-symbol">days:</span><span class="hljs-number">3</span><span class="hljs-string">', ...]) so this class
   could be instantiated outside of a rake task and the appropriate public method called with an argument array.
HELP
          puts help
        end
      end

    end
  end
end
</span></div></div></div></div></body></html>