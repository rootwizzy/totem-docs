<!DOCTYPE html><html lang="en"><head><title>thinkspace-weather-forecaster/app/models/thinkspace/weather_forecaster/response</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../"><meta name="groc-document-path" content="thinkspace-weather-forecaster/app/models/thinkspace/weather_forecaster/response"><meta name="groc-project-path" content="thinkspace-weather-forecaster/app/models/thinkspace/weather_forecaster/response.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../../../assets/style.css"><script type="text/javascript" src="../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/thinkspace-weather-forecaster/app/models/thinkspace/weather_forecaster/response.rb">thinkspace-weather-forecaster/app/models/thinkspace/weather_forecaster/response.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">WeatherForecaster</span></span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Response</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">ActiveRecord::Base</span></span></span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">response_score_metadata</span>;</span> get_response_score_metadata; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">input_value</span>;</span> get_input_value || <span class="hljs-keyword">nil</span>; <span class="hljs-keyword">end</span>
      totem_associations
      has_paper_trail

      validates_presence_of <span class="hljs-symbol">:thinkspace_weather_forecaster_forecast</span>, <span class="hljs-symbol">:thinkspace_weather_forecaster_assessment_item</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="scopes">Scopes.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">sum_response_scores</span></span>
        joins(<span class="hljs-symbol">:thinkspace_weather_forecaster_response_score</span>).
        sum(<span class="hljs-symbol">:score</span>)
      <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="instance-methods">Instance Methods.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_input_value</span>;</span> (<span class="hljs-keyword">self</span>.value || <span class="hljs-constant">Hash</span>.new)[<span class="hljs-string">'input'</span>]; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_or_create_response_score</span></span>
        response_score = <span class="hljs-keyword">self</span>.thinkspace_weather_forecaster_response_score
        <span class="hljs-keyword">if</span> response_score.blank?
          response_score = create_thinkspace_weather_forecaster_response_score
          raise <span class="hljs-constant">FindOrCreateError</span>, <span class="hljs-string">"Could not find or create response score for response [errors: <span class="hljs-subst">#{response_score.errors.messages}</span>] [<span class="hljs-subst">#{<span class="hljs-keyword">self</span>.inspect}</span>]."</span>  <span class="hljs-keyword">if</span> response_score.errors.present?
        <span class="hljs-keyword">end</span>
        raise <span class="hljs-constant">FindOrCreateError</span>, <span class="hljs-string">"Could not find or create response score for response [<span class="hljs-subst">#{<span class="hljs-keyword">self</span>.inspect}</span>]."</span>  <span class="hljs-keyword">if</span> response_score.blank?
        response_score
      <span class="hljs-keyword">end</span>

      <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FindOrCreateError</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">StandardError</span></span>;</span> <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="score">Score.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_response_score_metadata</span><span class="hljs-params">(options={})</span></span>
        response_score = <span class="hljs-keyword">self</span>.thinkspace_weather_forecaster_response_score
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> response_score.blank?
        add_response_score_values(options)
        options[<span class="hljs-symbol">:score</span>] = response_score.score
        options.slice(<span class="hljs-symbol">:is_correct</span>, <span class="hljs-symbol">:var_actual</span>, <span class="hljs-symbol">:score</span>)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calculate_score</span><span class="hljs-params">(options={})</span></span>
        add_response_score_values(options)
        add_processing(options)
        processing = options[<span class="hljs-symbol">:processing</span>]   || <span class="hljs-constant">Hash</span>.new
        incorrect  = processing[<span class="hljs-symbol">:incorrect</span>] || <span class="hljs-number">0</span>
        correct    = processing[<span class="hljs-symbol">:correct</span>]   || <span class="hljs-number">0</span>
        score      = options[<span class="hljs-symbol">:is_correct</span>].present? ? correct <span class="hljs-symbol">:</span> incorrect
        debug_message(options.merge(<span class="hljs-symbol">score:</span> score))  <span class="hljs-keyword">if</span> debug?(options)
        score
      <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="score-helpers">Score Helpers.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_response_score_values</span><span class="hljs-params">(options={})</span></span>
        item                = add_item(options)
        forecast_day_actual = add_forecast_day_actual(options)
        <span class="hljs-keyword">return</span> options <span class="hljs-keyword">if</span> forecast_day_actual.blank? || item.blank?
        options.merge!(forecast_day_actual.check_response(item.score_var, get_input_value))
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_item</span><span class="hljs-params">(options={})</span>;</span>            (options[<span class="hljs-symbol">:item</span>]            ||= <span class="hljs-keyword">self</span>.thinkspace_weather_forecaster_item); <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_assessment_item</span><span class="hljs-params">(options={})</span>;</span> (options[<span class="hljs-symbol">:assessment_item</span>] ||= <span class="hljs-keyword">self</span>.thinkspace_weather_forecaster_assessment_item); <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_forecast</span><span class="hljs-params">(options={})</span>;</span>        (options[<span class="hljs-symbol">:forecast</span>]        ||= <span class="hljs-keyword">self</span>.thinkspace_weather_forecaster_forecast); <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_score_var</span><span class="hljs-params">(options={})</span>;</span>       (options[<span class="hljs-symbol">:score_var</span>]       ||= add_item(options).score_var); <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_forecast_day_actual</span><span class="hljs-params">(options={})</span></span>
        options[<span class="hljs-symbol">:forecast_day_actual</span>] ||= <span class="hljs-keyword">begin</span>
          forecast = add_forecast(options)
          forecast_day_actual_class.scope_by_forecast(forecast)
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_processing</span><span class="hljs-params">(options={})</span></span>
        item                 = add_item(options)
        assessment_item      = add_assessment_item(options)
        processing           = (item.processing || <span class="hljs-constant">Hash</span>.new).deep_symbolize_keys
        options[<span class="hljs-symbol">:processing</span>] = processing.deep_merge((assessment_item.processing || <span class="hljs-constant">Hash</span>.new).deep_symbolize_keys)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug?</span><span class="hljs-params">(options)</span>;</span> options[<span class="hljs-symbol">:debug</span>].present?; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug_message</span><span class="hljs-params">(options={})</span></span>
        len      = <span class="hljs-number">20</span>
        forecast = add_forecast(options)
        puts <span class="hljs-string">"response.id: <span class="hljs-subst">#{<span class="hljs-keyword">self</span>.id}</span> "</span> + (<span class="hljs-string">'-'</span> * <span class="hljs-number">80</span>)
        puts <span class="hljs-string">'   ownerable'</span>.ljust(len)    + <span class="hljs-string">": <span class="hljs-subst">#{forecast.ownerable_type}</span>.<span class="hljs-subst">#{forecast.ownerable_id}</span> -&gt; <span class="hljs-subst">#{forecast.ownerable.title.inspect}</span>"</span>
        puts <span class="hljs-string">'   forecast at'</span>.ljust(len) + <span class="hljs-string">": <span class="hljs-subst">#{forecast.forecast_at.to_s(<span class="hljs-symbol">:db</span>)}</span>"</span>
        keys = options.keys.sort
        keys.each <span class="hljs-keyword">do</span> |key|
          value = options[key]
          puts <span class="hljs-string">"   <span class="hljs-subst">#{key}</span>"</span>.ljust(len) + <span class="hljs-string">": <span class="hljs-subst">#{value.inspect}</span>"</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forecast_day_actual_class</span>;</span> <span class="hljs-constant">Thinkspace::WeatherForecaster::ForecastDayActual</span>; <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></div></div></div></div></body></html>