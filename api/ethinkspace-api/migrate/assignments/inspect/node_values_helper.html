<!DOCTYPE html><html lang="en"><head><title>migrate/assignments/inspect/node_values_helper</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="migrate/assignments/inspect/node_values_helper"><meta name="groc-project-path" content="migrate/assignments/inspect/node_values_helper.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/migrate/assignments/inspect/node_values_helper.rb">migrate/assignments/inspect/node_values_helper.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">require</span> <span class="hljs-constant">File</span>.expand_path(<span class="hljs-string">'../../helpers/require_all'</span>, __FILE_<span class="hljs-number">_</span>)
<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Migrate</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Assignments</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Inspect</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">NodeValuesHelper</span></span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collect_node_values</span><span class="hljs-params">(node, options={})</span></span>
      only   = [options[<span class="hljs-symbol">:only</span>]].flatten.compact.map{|v| v.to_s}
      except = [options[<span class="hljs-symbol">:except</span>]].flatten.compact.map{|v| v.to_s} + [<span class="hljs-string">'_id'</span>]  <span class="hljs-keyword">if</span> only.blank?
      <span class="hljs-keyword">if</span> <span class="hljs-variable">@collected_values_count</span>.blank?
        <span class="hljs-variable">@collected_values_count</span> = <span class="hljs-number">0</span>
        <span class="hljs-variable">@collected_values</span>       = <span class="hljs-constant">Hash</span>.new
      <span class="hljs-keyword">end</span>
      hash     = <span class="hljs-constant">Hash</span>.from_xml(node.to_s)
      root_key = hash.keys.uniq.first
      hash[root_key].each <span class="hljs-keyword">do</span> |k, v|
        <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> only.present? &amp;&amp; !only.<span class="hljs-keyword">include</span>?(k)
        <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> except.<span class="hljs-keyword">include</span>?(k)
        <span class="hljs-variable">@collected_values</span>[k] ||= <span class="hljs-constant">Array</span>.new
        <span class="hljs-variable">@collected_values</span>[k].push(v.<span class="hljs-keyword">nil</span>? ? <span class="hljs-string">'nil'</span> <span class="hljs-symbol">:</span> v)
      <span class="hljs-keyword">end</span>
      <span class="hljs-variable">@collected_values_count</span> += <span class="hljs-number">1</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_collected_node_values</span><span class="hljs-params">(*args)</span></span>
      options     = args.extract_options!
      count_title = args.shift || <span class="hljs-string">'Count'</span>
      only        = [options[<span class="hljs-symbol">:only</span>]].flatten.compact.map{|v| v.to_s}
      except      = [options[<span class="hljs-symbol">:except</span>]].flatten.compact.map{|v| v.to_s} <span class="hljs-keyword">if</span> only.blank?
      <span class="hljs-keyword">case</span>
      <span class="hljs-keyword">when</span> only.present?
        keys = only.sort
      <span class="hljs-keyword">when</span> except.present?
        keys = <span class="hljs-variable">@collected_values</span>.keys.sort - except
      <span class="hljs-keyword">else</span>
        keys = <span class="hljs-variable">@collected_values</span>.keys.sort
      <span class="hljs-keyword">end</span>
      keys.each_with_index <span class="hljs-keyword">do</span> |key, index|
        array = (<span class="hljs-variable">@collected_values</span> || <span class="hljs-constant">Hash</span>.new)[key] || <span class="hljs-constant">Array</span>.new
        puts <span class="hljs-string">"\n"</span>
        puts <span class="hljs-string">"<span class="hljs-subst">#{(index+<span class="hljs-number">1</span>).to_s.rjust(<span class="hljs-number">4</span>)}</span>. <span class="hljs-subst">#{key.inspect}</span> "</span>.ljust(<span class="hljs-number">80</span>, <span class="hljs-string">'-'</span>)
        uvs = array.uniq.sort
        len = uvs.map{|uv| uv.present? ? uv.length <span class="hljs-symbol">:</span> <span class="hljs-number">0</span>}.max || <span class="hljs-number">0</span>
        len += <span class="hljs-number">2</span>   <span class="hljs-keyword">if</span> len &gt; <span class="hljs-number">0</span>
        len = <span class="hljs-number">120</span>  <span class="hljs-keyword">if</span> len &gt; <span class="hljs-number">120</span>
        uvs.each_with_index <span class="hljs-keyword">do</span> |uv, i|
          puv = uv.inspect.ljust(len)
          puts <span class="hljs-string">"     <span class="hljs-subst">#{(i+<span class="hljs-number">1</span>).to_s.rjust(<span class="hljs-number">4</span>)}</span>. <span class="hljs-subst">#{puv}</span> (count: <span class="hljs-subst">#{array.count(uv)}</span>)"</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>
      puts <span class="hljs-string">"\n"</span>
      puts <span class="hljs-string">"<span class="hljs-subst">#{count_title}</span>: <span class="hljs-subst">#{<span class="hljs-variable">@collected_values_count</span>}</span>"</span>
      puts <span class="hljs-string">"\n"</span>
    <span class="hljs-keyword">end</span>

  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span></div></div></div></div></body></html>