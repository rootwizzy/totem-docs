<!DOCTYPE html><html lang="en"><head><title>migrate/diagnostic_paths_to_indented_lists/helpers/phase_templates</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="migrate/diagnostic_paths_to_indented_lists/helpers/phase_templates"><meta name="groc-project-path" content="migrate/diagnostic_paths_to_indented_lists/helpers/phase_templates.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/migrate/diagnostic_paths_to_indented_lists/helpers/phase_templates.rb">migrate/diagnostic_paths_to_indented_lists/helpers/phase_templates.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Migrate</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">DiagnosticPathsToIndentedLists</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Helpers</span>;</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhaseTemplates</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="list-domain-data-will-not-be-called-if-passed-in-options">List Domain Data (will not be called if passed in options).</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_list_common_component</span></span>
    titles     = list_common_component_titles
    components = component_class.where(<span class="hljs-symbol">title:</span> titles)
    raise_error <span class="hljs-string">"List common component not found with a title in <span class="hljs-subst">#{titles}</span>."</span>  <span class="hljs-keyword">if</span> components.blank?
    raise_error <span class="hljs-string">"More than one list common component exists.  Cannot determine correct one <span class="hljs-subst">#{components.inspect}</span>.  Use component:id option."</span>  <span class="hljs-keyword">if</span> components.length &gt; <span class="hljs-number">1</span>
    components.first
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_list_phase_template</span></span>
    name           = <span class="hljs-string">'two_column_indented_list_observation_list_submit'</span>
    phase_template = phase_template_class.find_by(<span class="hljs-symbol">name:</span> name)
    raise_error <span class="hljs-string">"List phase template <span class="hljs-subst">#{name.inspect}</span> not found."</span>  <span class="hljs-keyword">if</span> phase_template.blank?
    phase_template
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_expert_list_phase_template</span></span>
    name = <span class="hljs-string">'one_column_indented_list'</span>
    phase_template = phase_template_class.find_by(<span class="hljs-symbol">name:</span> name)
    raise_error <span class="hljs-string">"Expert list phase template <span class="hljs-subst">#{name.inspect}</span> not found."</span>  <span class="hljs-keyword">if</span> phase_template.blank?
    phase_template
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_phase_component_section_in_list_template</span><span class="hljs-params">(list_phase_template)</span></span>
    titles = list_common_component_titles
    hash   = parse_phase_template(list_phase_template.template).find {|c| titles.<span class="hljs-keyword">include</span>?(c[<span class="hljs-symbol">:title</span>])}
    raise_error <span class="hljs-string">"List phase template does not have a common component title of <span class="hljs-subst">#{common_components}</span>. <span class="hljs-subst">#{list_phase_template.inspect}</span>"</span>  <span class="hljs-keyword">if</span> hash.blank?
    section = hash[<span class="hljs-symbol">:section</span>]
    raise_error <span class="hljs-string">"List phase template section is blank <span class="hljs-subst">#{hash.inspect}</span>."</span>  <span class="hljs-keyword">if</span> section.blank?
    section
  <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="validate-path-template-and-list-template-are-compatible">Validate Path Template and List Template are Compatible.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_phase_templates</span><span class="hljs-params">(phase, list_phase_template)</span></span>
    phase_template = get_phase_template_from_phase(phase)
    template       = parse_phase_template(phase_template.template)
    raise_error <span class="hljs-string">"Phase template <span class="hljs-subst">#{phase_template.id}</span> template content is blank for phase <span class="hljs-subst">#{phase.inspect}</span>."</span>  <span class="hljs-keyword">if</span> template.blank?
    list_template  = parse_phase_template(list_phase_template.template)
    raise_error <span class="hljs-string">"List phase template <span class="hljs-subst">#{list_phase_template.id}</span> template content is blank."</span>  <span class="hljs-keyword">if</span> list_template.blank?
    validate_templates(template, list_template)
  <span class="hljs-keyword">end</span>

  private</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="domain-data-modify-to-match-typical-run">Domain Data (modify to match typical run).</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_common_component_titles</span>;</span> [<span class="hljs-string">'indented-list'</span>]; <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list_template_sections</span>;</span> list_common_component_titles + [<span class="hljs-string">'list'</span>]; <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">diagnostic_path_common_component_titles</span>;</span> [<span class="hljs-string">'diagnostic-path'</span>]; <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">diagnostic_path_template_sections</span>;</span> diagnostic_path_common_component_titles + [<span class="hljs-string">'diag-path'</span>]; <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="helpers">Helpers.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">component_class</span>;</span>      <span class="hljs-constant">::Thinkspace::Common::Component</span>; <span class="hljs-keyword">end</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">phase_template_class</span>;</span> <span class="hljs-constant">::Thinkspace::Casespace::PhaseTemplate</span>; <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_phase_template_from_phase</span><span class="hljs-params">(phase)</span></span>
    phase_template = phase.thinkspace_casespace_phase_template
    raise_error <span class="hljs-string">"Phase id <span class="hljs-subst">#{phase.id}</span> phase template is blank."</span>  <span class="hljs-keyword">if</span> phase_template.blank?
    phase_template
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_phase_template</span><span class="hljs-params">(template)</span></span>
    array      = <span class="hljs-constant">Array</span>.new
    html       = <span class="hljs-constant">Nokogiri::HTML</span>.fragment(template)
    components = html.css(<span class="hljs-string">'component'</span>)
    components.each <span class="hljs-keyword">do</span> |component|
      comp = <span class="hljs-constant">Hash</span>.from_xml(component.to_s)[<span class="hljs-string">'component'</span>] || <span class="hljs-constant">Hash</span>.new
      array.push(comp.symbolize_keys)
    <span class="hljs-keyword">end</span>
    array
  <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="validate-templates">Validate Templates.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_templates</span><span class="hljs-params">(template, list_template)</span></span>
    validate_template_titles(template, list_template)
    validate_template_sections(template, list_template)
    validate_template_sources(template, list_template)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_template_titles</span><span class="hljs-params">(template, list_template)</span></span>
    phase_titles = template.collect       {|c| c[<span class="hljs-symbol">:title</span>]}.compact
    list_titles  = list_template.collect  {|c| c[<span class="hljs-symbol">:title</span>]}.compact
    ptitles      = (phase_titles - diagnostic_path_common_component_titles).sort
    ltitles      = (list_titles  - list_common_component_titles).sort
    raise_error <span class="hljs-string">"Template titles differ.  Phase template <span class="hljs-subst">#{ptitles}</span>, List template <span class="hljs-subst">#{ltitles}</span>."</span>  <span class="hljs-keyword">unless</span> ptitles == ltitles
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_template_sections</span><span class="hljs-params">(template, list_template)</span></span>
    phase_sections = template.collect       {|c| c[<span class="hljs-symbol">:section</span>] || c[<span class="hljs-symbol">:title</span>]}.compact
    list_sections  = list_template.collect  {|c| c[<span class="hljs-symbol">:section</span>] || c[<span class="hljs-symbol">:title</span>]}.compact
    psections      = (phase_sections - diagnostic_path_template_sections).sort
    lsections      = (list_sections  - list_template_sections).sort
    raise_error <span class="hljs-string">"Template sections differ.  Phase template <span class="hljs-subst">#{psections}</span>, List template <span class="hljs-subst">#{lsections}</span>."</span>  <span class="hljs-keyword">unless</span> psections == lsections
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_template_sources</span><span class="hljs-params">(template, list_template)</span></span>
    psources = template.collect       {|c| c[<span class="hljs-symbol">:source</span>]}.compact.sort
    lsources = list_template.collect  {|c| c[<span class="hljs-symbol">:source</span>]}.compact.sort
    raise_error <span class="hljs-string">"Template sources differ.  Phase template <span class="hljs-subst">#{psources}</span>, List template <span class="hljs-subst">#{lsources}</span>."</span>  <span class="hljs-keyword">unless</span> psources == lsources
  <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="errors">Errors.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">raise_error</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
    raise <span class="hljs-constant">PhaseTemplatesError</span>, message
  <span class="hljs-keyword">end</span>

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhaseTemplatesError</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">StandardError</span></span>;</span> <span class="hljs-keyword">end</span>

<span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span></div></div></div></div></body></html>