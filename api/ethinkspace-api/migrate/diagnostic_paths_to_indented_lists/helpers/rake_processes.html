<!DOCTYPE html><html lang="en"><head><title>migrate/diagnostic_paths_to_indented_lists/helpers/rake_processes</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="migrate/diagnostic_paths_to_indented_lists/helpers/rake_processes"><meta name="groc-project-path" content="migrate/diagnostic_paths_to_indented_lists/helpers/rake_processes.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/migrate/diagnostic_paths_to_indented_lists/helpers/rake_processes.rb">migrate/diagnostic_paths_to_indented_lists/helpers/rake_processes.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Migrate</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">DiagnosticPathsToIndentedLists</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Helpers</span>;</span> <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">RakeProcesses</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the &#39;phase_scope&#39; based on the rake task and ids in the args.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:phase_scope</span>
  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:expert_phase_scope</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="rake-tasks">Rake Tasks.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_all</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
    <span class="hljs-variable">@phase_scope</span> = phase_class.all.order(<span class="hljs-symbol">:id</span>)
    set_additional_options_and_convert(args)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_spaces</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
    ids = extract_process_ids(args, space_class)
    process_ids_stop_run(<span class="hljs-symbol">:spaces</span>)  <span class="hljs-keyword">if</span> ids.blank?
    spaces           = space_class.where(<span class="hljs-symbol">id:</span> ids)
    phase_ids        = get_spaces_phase_ids(spaces)
    expert_phase_ids = get_spaces_expert_phase_ids(spaces)
    process_common(args, phase_ids)
    process_expert(args, expert_phase_ids)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_assignments</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
    ids = extract_process_ids(args, assignment_class)
    process_ids_stop_run(<span class="hljs-symbol">:assignments</span>)  <span class="hljs-keyword">if</span> ids.blank?
    assignments      = assignment_class.where(<span class="hljs-symbol">id:</span> ids)
    phase_ids        = get_assignments_phase_ids(assignments)
    expert_phase_ids = get_assignments_expert_phase_ids(assignments)
    process_common(args, phase_ids)
    process_expert(args, expert_phase_ids)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_phases</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
    ids = extract_process_ids(args, phase_class)
    process_ids_stop_run(<span class="hljs-symbol">:phases</span>)  <span class="hljs-keyword">if</span> ids.blank?
    process_common(args, ids)
    process_expert(args, ids)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_paths</span><span class="hljs-params">(args=<span class="hljs-keyword">nil</span>)</span></span>
    ids = extract_process_ids(args, path_class)
    process_ids_stop_run(<span class="hljs-symbol">:paths</span>)  <span class="hljs-keyword">if</span> ids.blank?
    <span class="hljs-variable">@path_ids</span> = ids
    phase_ids = get_paths_phase_ids(ids)
    process_common(args, phase_ids)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_ids_stop_run</span><span class="hljs-params">(model)</span></span>
    model = model.to_s
    stop_run <span class="hljs-string">"Rake task <span class="hljs-subst">#{model.inspect}</span> required <span class="hljs-subst">#{model}</span> ids.  Add <span class="hljs-subst">#{model}</span> ids in the options."</span>
  <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="set-addition-args-phase-scope-then-call-convert">Set: Addition Args, Phase Scope then Call Convert.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_common</span><span class="hljs-params">(args, phase_ids)</span></span>
    stop_run <span class="hljs-string">"No phases where selected from the options."</span>  <span class="hljs-keyword">if</span> phase_ids.blank?
    <span class="hljs-variable">@phase_scope</span> = phase_class.where(<span class="hljs-symbol">id:</span> phase_ids.uniq.sort)
    set_additional_options_and_convert(args)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_expert</span><span class="hljs-params">(args, phase_ids)</span></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> phase_ids.blank?
    <span class="hljs-variable">@expert_phase_scope</span> = phase_class.where(<span class="hljs-symbol">id:</span> phase_ids.uniq.sort)
    convert_expert(args)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_additional_options_and_convert</span><span class="hljs-params">(args)</span></span>
    <span class="hljs-variable">@args_string</span> = args.join(<span class="hljs-string">','</span>)
    set_list_component_from_args(args)
    set_list_phase_template_from_args(args)
    set_list_phase_component_section_from_args(args)
    set_destroy_path_from_args(args)
    set_debug_from_args(args)
    print_args
    convert_phases_to_indented_lists
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_expert</span><span class="hljs-params">(args)</span></span>
    print_args
    convert_phases_to_expert_indented_lists
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_list_component_from_args</span><span class="hljs-params">(args)</span></span>
    arg = args.find {|a| a.start_with?(<span class="hljs-string">'component:'</span>)}
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> arg.blank?
    id        = extract_arg_value(arg)
    component = component_class.find_by(<span class="hljs-symbol">id:</span> id)
    stop_run <span class="hljs-string">"Arg common component id <span class="hljs-subst">#{id}</span> not found."</span>  <span class="hljs-keyword">if</span> component.blank?
    <span class="hljs-variable">@list_component</span> = component
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_list_phase_template_from_args</span><span class="hljs-params">(args)</span></span>
    arg = args.find {|a| a.start_with?(<span class="hljs-string">'phase_template:'</span>) || a.start_with?(<span class="hljs-string">'template:'</span>)}
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> arg.blank?
    id             = extract_arg_value(arg)
    phase_template = phase_template_class.find_by(<span class="hljs-symbol">id:</span> id)
    stop_run <span class="hljs-string">"Arg phase template id <span class="hljs-subst">#{id}</span> not found."</span>  <span class="hljs-keyword">if</span> phase_template.blank?
    <span class="hljs-variable">@list_phase_template</span> = phase_template
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_list_phase_component_section_from_args</span><span class="hljs-params">(args)</span></span>
    arg = args.find {|a| a.start_with?(<span class="hljs-string">'section:'</span>)}
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> arg.blank?
    <span class="hljs-variable">@list_phase_component_section</span> = extract_arg_value(arg)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_destroy_path_from_args</span><span class="hljs-params">(args)</span></span>
    arg = args.find {|a| a == <span class="hljs-string">'destroy_path'</span> || a == <span class="hljs-string">'destroy-path'</span>}
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> arg.blank?
    <span class="hljs-variable">@destroy_path</span> = <span class="hljs-keyword">true</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_debug_from_args</span><span class="hljs-params">(args)</span></span>
    arg = args.find {|a| a == <span class="hljs-string">'debug'</span>}
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> arg.blank?
    <span class="hljs-variable">@debug</span> = <span class="hljs-keyword">true</span>
  <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="scope-helpers">Scope Helpers.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spaces_phase_ids</span><span class="hljs-params">(spaces)</span></span>
    phase_ids = <span class="hljs-constant">Array</span>.new
    spaces.each <span class="hljs-keyword">do</span> |space|
      phase_ids += get_assignments_phase_ids(space.thinkspace_casespace_assignments)
    <span class="hljs-keyword">end</span>
    phase_ids
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_assignments_phase_ids</span><span class="hljs-params">(assignments)</span></span>
    phase_ids = <span class="hljs-constant">Array</span>.new
    assignments.each <span class="hljs-keyword">do</span> |assignment|
      phases      = assignment.thinkspace_casespace_phases
      path_phases = phases.joins(<span class="hljs-symbol">:thinkspace_casespace_phase_components</span>).where(<span class="hljs-string">'thinkspace_casespace_phase_components.componentable_type = ?'</span>, path_class.name)
      phase_ids   += path_phases.pluck(<span class="hljs-symbol">:id</span>)
    <span class="hljs-keyword">end</span>
    phase_ids
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spaces_expert_phase_ids</span><span class="hljs-params">(spaces)</span></span>
    phase_ids = <span class="hljs-constant">Array</span>.new
    spaces.each <span class="hljs-keyword">do</span> |space|
      phase_ids += get_assignments_expert_phase_ids(space.thinkspace_casespace_assignments)
    <span class="hljs-keyword">end</span>
    phase_ids
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_assignments_expert_phase_ids</span><span class="hljs-params">(assignments)</span></span>
    phase_ids = <span class="hljs-constant">Array</span>.new
    assignments.each <span class="hljs-keyword">do</span> |assignment|
      phases      = assignment.thinkspace_casespace_phases
      path_phases = phases.joins(<span class="hljs-symbol">:thinkspace_casespace_phase_components</span>).where(<span class="hljs-string">'thinkspace_casespace_phase_components.componentable_type = ?'</span>, path_viewer_class.name)
      phase_ids   += path_phases.pluck(<span class="hljs-symbol">:id</span>)
    <span class="hljs-keyword">end</span>
    phase_ids
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_paths_phase_ids</span><span class="hljs-params">(path_ids)</span></span>
    paths     = path_class.where(<span class="hljs-symbol">id:</span> path_ids)
    phase_ids = <span class="hljs-constant">Array</span>.new
    paths.each <span class="hljs-keyword">do</span> |path|
      phase = path.authable
      stop_run <span class="hljs-string">"Path authable is not a phase <span class="hljs-subst">#{path.inspect}</span> but is <span class="hljs-subst">#{phase.inspect}</span>."</span>  <span class="hljs-keyword">unless</span> phase.is_a?(phase_class)
      phase_ids.push(phase.id)
    <span class="hljs-keyword">end</span>
    phase_ids
  <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="helpers">Helpers.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_process_ids</span><span class="hljs-params">(args, klass)</span></span>
    ids = args.select {|a| is_digits?(a)}
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> ids.blank?
    ids = ids.map {|id| id.to_i}
    validate_ids(klass, ids)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_ids</span><span class="hljs-params">(klass, ids)</span></span>
    ids.each <span class="hljs-keyword">do</span> |id|
      record = klass.find_by(<span class="hljs-symbol">id:</span> id)
      stop_run <span class="hljs-string">"Record '<span class="hljs-subst">#{klass.name}</span>.<span class="hljs-subst">#{id}</span>' not found."</span>  <span class="hljs-keyword">if</span> record.blank?
    <span class="hljs-keyword">end</span>
    ids
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_arg_value</span><span class="hljs-params">(arg)</span></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> arg.blank?
    val = arg.split(<span class="hljs-string">':'</span>,<span class="hljs-number">2</span>).last
    val.blank? ? <span class="hljs-keyword">nil</span> <span class="hljs-symbol">:</span> val.to_s.strip
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_digits?</span><span class="hljs-params">(arg)</span></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> arg.blank?
    arg.match(<span class="hljs-regexp">/^\d+$/</span>)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_args</span></span>
    hash                           = <span class="hljs-constant">Hash</span>.new
    hash[<span class="hljs-symbol">:arg_string</span>]              = <span class="hljs-variable">@args_string</span>
    hash[<span class="hljs-symbol">:destroy_path</span>]            = <span class="hljs-variable">@destroy_path</span>
    hash[<span class="hljs-symbol">:debug</span>]                   = <span class="hljs-variable">@debug</span>
    hash[<span class="hljs-symbol">:component</span>]               = <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-variable">@list_component</span>.id}</span> (<span class="hljs-subst">#{<span class="hljs-variable">@list_component</span>.title}</span>)"</span>  <span class="hljs-keyword">if</span> <span class="hljs-variable">@list_component</span>.present?
    hash[<span class="hljs-symbol">:phase_template</span>]          = <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-variable">@list_phase_template</span>.id}</span> (<span class="hljs-subst">#{<span class="hljs-variable">@list_phase_template</span>.name}</span>)"</span>  <span class="hljs-keyword">if</span> <span class="hljs-variable">@list_phase_template</span>.present?
    hash[<span class="hljs-symbol">:phase_component_section</span>] = <span class="hljs-variable">@list_phase_component_section</span>  <span class="hljs-keyword">if</span> <span class="hljs-variable">@list_phase_component_section</span>.present?
    hash[<span class="hljs-symbol">:path_ids</span>]                = <span class="hljs-variable">@path_ids</span>                      <span class="hljs-keyword">if</span> <span class="hljs-variable">@path_ids</span>.present?
    hash[<span class="hljs-symbol">:phase_ids</span>]               = phase_scope.map(&amp;<span class="hljs-symbol">:id</span>)
    print_hash(hash)
  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span>; <span class="hljs-keyword">end</span></div></div></div></div></body></html>