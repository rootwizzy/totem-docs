<!DOCTYPE html><html lang="en"><head><title>thinkspace-lab/app/models/thinkspace/lab/observation</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../"><meta name="groc-document-path" content="thinkspace-lab/app/models/thinkspace/lab/observation"><meta name="groc-project-path" content="thinkspace-lab/app/models/thinkspace/lab/observation.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../../../assets/style.css"><script type="text/javascript" src="../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/thinkspace-lab/app/models/thinkspace/lab/observation.rb">thinkspace-lab/app/models/thinkspace/lab/observation.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Thinkspace</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Lab</span></span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Observation</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">ActiveRecord::Base</span></span>        </span>
      validates_presence_of <span class="hljs-symbol">:thinkspace_lab_result</span>
      totem_associations
      has_paper_trail

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">category_observation_keys</span>;</span> <span class="hljs-keyword">self</span>.thinkspace_lab_category.observation_keys; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">locked_state</span>;</span>   <span class="hljs-string">'locked'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unlocked_state</span>;</span> <span class="hljs-string">'unlocked'</span>; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_updateable?</span></span>
        <span class="hljs-keyword">self</span>.state != locked_state
      <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="metadata">Metadata.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_metadata</span><span class="hljs-params">(result=<span class="hljs-keyword">nil</span>, category=<span class="hljs-keyword">nil</span>)</span></span>
        result   = <span class="hljs-keyword">self</span>.thinkspace_lab_result
        category = <span class="hljs-keyword">self</span>.thinkspace_lab_category
        (category.metadata || <span class="hljs-constant">Hash</span>.new).deep_merge(result.metadata || <span class="hljs-constant">Hash</span>.new)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_metadata</span><span class="hljs-params">(key, metadata=<span class="hljs-keyword">nil</span>)</span></span>
        metadata ||= get_metadata
        metadata[key] || <span class="hljs-constant">Hash</span>.new
      <span class="hljs-keyword">end</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="observation">Observation.</h3>
<h2 id="">#</h2></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_value</span><span class="hljs-params">(key)</span>;</span> <span class="hljs-keyword">self</span>.value[key]; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_last_value</span><span class="hljs-params">(key)</span>;</span> get_key_archive(key)[values_key].last; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_attempts</span><span class="hljs-params">(key)</span>;</span> get_key_detail(key)[attempts_key]; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_detail</span><span class="hljs-params">(key)</span></span>
        <span class="hljs-keyword">self</span>.detail[key].reverse_merge!({
          attempts_key =&gt; <span class="hljs-number">0</span>,
        })
      <span class="hljs-keyword">end</span>
      
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_archive</span><span class="hljs-params">(key)</span></span>
        <span class="hljs-keyword">self</span>.archive[key].reverse_merge!({
          values_key =&gt; [],
        })
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_state</span><span class="hljs-params">(obs_state)</span>;</span> <span class="hljs-keyword">self</span>.state = obs_state; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_all_correct</span><span class="hljs-params">(val)</span>;</span> <span class="hljs-keyword">self</span>.all_correct = val; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">increment_attempts</span>;</span>   <span class="hljs-keyword">self</span>.attempts += <span class="hljs-number">1</span>; <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="">#</h2>
<h3 id="observation-key">Observation Key.</h3>
<h2 id="">#</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>In the future could format key value based on metadata e.g. string, number, date, etc. (currently assumes string and metadata not used).</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_value</span><span class="hljs-params">(key, val, options={})</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>metadata        = get_key_metadata(key, options)</p></div></div><div class="code"><div class="wrapper">        key_value       = val.<span class="hljs-keyword">nil</span>? ? <span class="hljs-keyword">nil</span> <span class="hljs-symbol">:</span> val.to_s.strip
        <span class="hljs-keyword">self</span>.value[key] = key_value
        key_value
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_correct</span><span class="hljs-params">(key, val, options={})</span>;</span> <span class="hljs-keyword">self</span>.detail[key][correct_key] = key_value_correct?(key, val, options); <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_locked</span><span class="hljs-params">(key, val)</span>;</span> <span class="hljs-keyword">self</span>.detail[key][locked_key] = val; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_attempts_exceeded</span><span class="hljs-params">(key, val)</span>;</span> <span class="hljs-keyword">self</span>.detail[key][attempts_exceeded_key] = val; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_attempts</span><span class="hljs-params">(key, val)</span>;</span> <span class="hljs-keyword">self</span>.detail[key][attempts_key] = val; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">increment_key_attempts</span><span class="hljs-params">(key)</span>;</span> set_key_attempts(key, get_key_attempts(key) + <span class="hljs-number">1</span>); <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_key_archive_value</span><span class="hljs-params">(key, val)</span>;</span> get_key_archive(key)[values_key].push(val); <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_values</span><span class="hljs-params">(value_hash={}, options={})</span></span>
        init_json_columns
        obs_state = unlocked_state
        metadata  = options[<span class="hljs-symbol">:metadata</span>] || get_metadata
        keys      = options[<span class="hljs-symbol">:keys</span>]     || category_observation_keys
        <span class="hljs-keyword">self</span>.value.merge!(value_hash.stringify_keys)
        all_correct = <span class="hljs-keyword">true</span>
        keys.each <span class="hljs-keyword">do</span> |key|
          <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> key_defined_as_no_value?(key, <span class="hljs-symbol">metadata:</span> metadata)
          init_key_json(key)
          val         = set_key_value(key, get_key_value(key), <span class="hljs-symbol">metadata:</span> metadata)  <span class="hljs-comment"># format the key value e.g. currently assumes string.strip</span>
          correct     = set_key_correct(key, val, <span class="hljs-symbol">metadata:</span> metadata)
          all_correct = <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> correct.blank?</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add value to archive unless same as last observation value.</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">unless</span> (val.<span class="hljs-keyword">nil</span>? || val == get_key_last_value(key))
            add_key_archive_value(key, val)
            increment_key_attempts(key)
          <span class="hljs-keyword">end</span>
          key_state = set_key_state(key, <span class="hljs-symbol">metadata:</span> metadata)
          obs_state = key_state <span class="hljs-keyword">unless</span> obs_state == locked_state  <span class="hljs-comment"># locked by a key, so do not unlock</span>
         <span class="hljs-keyword">end</span>
         set_all_correct(all_correct)
         set_state(obs_state)  <span class="hljs-comment"># overall observation state</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">key_defined_as_no_value?</span><span class="hljs-params">(key, options={})</span></span>
        metadata = get_key_metadata(key, options[<span class="hljs-symbol">:metadata</span>])
        metadata[no_value_key] == <span class="hljs-keyword">true</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_key_state</span><span class="hljs-params">(key, options={})</span></span>
        metadata = get_key_metadata(key, options[<span class="hljs-symbol">:metadata</span>])
        max      = metadata[max_attempts_key]
        <span class="hljs-keyword">case</span>
        <span class="hljs-keyword">when</span> max.blank? || max.to_s == <span class="hljs-string">'no_limit'</span>
          set_key_locked(key, <span class="hljs-keyword">false</span>)
          set_key_attempts_exceeded(key, <span class="hljs-keyword">false</span>)
          unlocked_state
        <span class="hljs-keyword">when</span> (<span class="hljs-keyword">not</span> lock_on_max_attempts?(key))
          set_key_locked(key, <span class="hljs-keyword">false</span>)
          set_key_attempts_exceeded(key, max &lt;= get_key_attempts(key))
          unlocked_state
        <span class="hljs-keyword">when</span> max &gt; get_key_attempts(key)
          set_key_locked(key, <span class="hljs-keyword">false</span>)
          set_key_attempts_exceeded(key, <span class="hljs-keyword">false</span>)
          unlocked_state
        <span class="hljs-keyword">else</span>
          set_key_locked(key, <span class="hljs-keyword">true</span>)
          set_key_attempts_exceeded(key, max &lt;= get_key_attempts(key))
          locked_state
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lock_on_max_attempts?</span><span class="hljs-params">(key, options={})</span></span>
        metadata  = get_key_metadata(key, options[<span class="hljs-symbol">:metadata</span>])
        metadata[lock_on_max_attempts_key] != <span class="hljs-keyword">false</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">key_value_correct?</span><span class="hljs-params">(key, val, options={})</span></span>
        metadata = get_key_metadata(key, options[<span class="hljs-symbol">:metadata</span>])
        validate = metadata[validate_key] || <span class="hljs-constant">Hash</span>.new
        <span class="hljs-keyword">return</span> key_value_correct_method(key, val, options)  <span class="hljs-keyword">if</span> validate.has_key?(correct_method_key)
        correct  = validate[correct_key]
        multiple = validate[multiple_key]
        correct  = [correct].flatten.compact.collect {|c| c.downcase}
        <span class="hljs-keyword">case</span>
        <span class="hljs-keyword">when</span> any_key_value_correct?(correct)
          <span class="hljs-keyword">true</span>
        <span class="hljs-keyword">when</span> val.<span class="hljs-keyword">nil</span>?
          <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">when</span> multiple.blank?
          val = val.downcase  <span class="hljs-keyword">if</span> val.is_a?(<span class="hljs-constant">String</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only need to match one of the correct values.</p></div></div><div class="code"><div class="wrapper">          correct.<span class="hljs-keyword">include</span>?(val)
        <span class="hljs-keyword">else</span>
          val = val.downcase  <span class="hljs-keyword">if</span> val.is_a?(<span class="hljs-constant">String</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Mutiple values possible, split on comma to get the values then check againt correct values.</p></div></div><div class="code"><div class="wrapper">          match_all = validate[multiple_match_all_key]
          val       = val.split(<span class="hljs-string">','</span>).each {|v| v.strip}
          <span class="hljs-keyword">if</span> match_all.present?
            correct.length == val.length &amp;&amp; (correct - val).blank?
          <span class="hljs-keyword">else</span>
            correct.<span class="hljs-keyword">include</span>?(val)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: Need to implement specific method validation.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">key_value_correct_method</span><span class="hljs-params">(key, val, options={})</span></span>
        metadata = get_key_metadata(key, options[<span class="hljs-symbol">:metadata</span>])
        validate = metadata[validate_key] || <span class="hljs-constant">Hash</span>.new
        method   = validate[correct_method_key]
        <span class="hljs-keyword">case</span>
        <span class="hljs-keyword">when</span> method.blank?
          <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">when</span> method == <span class="hljs-string">'standard_adjusted'</span>
          correct = validate[correct_key]
          val.to_f == correct.to_f <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> Make more friendly with rounding, etc.</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">any_key_value_correct?</span><span class="hljs-params">(correct)</span></span>
        correct.blank? || (correct.length == <span class="hljs-number">1</span> &amp;&amp; correct.first.to_s == <span class="hljs-string">'anything'</span>)  <span class="hljs-comment"># Blank correct value in metadata for key, assumes true.</span>
      <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Provide consistency for detail/archive json keys.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">values_key</span>;</span>               <span class="hljs-string">'values'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">locked_key</span>;</span>               <span class="hljs-string">'locked'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">all_correct_key</span>;</span>          <span class="hljs-string">'all_correct'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">correct_key</span>;</span>              <span class="hljs-string">'correct'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">correct_method_key</span>;</span>       <span class="hljs-string">'correct_method'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">attempts_key</span>;</span>             <span class="hljs-string">'attempts'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">attempts_exceeded_key</span>;</span>    <span class="hljs-string">'attempts_exceeded'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">max_attempts_key</span>;</span>         <span class="hljs-string">'max_attempts'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">no_value_key</span>;</span>             <span class="hljs-string">'no_value'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_key</span>;</span>             <span class="hljs-string">'validate'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multiple_key</span>;</span>             <span class="hljs-string">'multiple'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multiple_match_all_key</span>;</span>   <span class="hljs-string">'multiple_match_all'</span>; <span class="hljs-keyword">end</span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lock_on_max_attempts_key</span>;</span> <span class="hljs-string">'lock_on_max_attempts'</span>; <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_json_columns</span></span>
        <span class="hljs-keyword">self</span>.value   ||= <span class="hljs-constant">Hash</span>.new
        <span class="hljs-keyword">self</span>.detail  ||= <span class="hljs-constant">Hash</span>.new
        <span class="hljs-keyword">self</span>.archive ||= <span class="hljs-constant">Hash</span>.new
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_key_json</span><span class="hljs-params">(key)</span></span>
        <span class="hljs-keyword">self</span>.detail[key]  ||= <span class="hljs-constant">Hash</span>.new
        <span class="hljs-keyword">self</span>.archive[key] ||= <span class="hljs-constant">Hash</span>.new
      <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></div></div></div></div></body></html>