<!DOCTYPE html><html lang="en"><head><title>thinkspace-casespace/db/helpers/seed_config/casespace_config_models_helper</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="thinkspace-casespace/db/helpers/seed_config/casespace_config_models_helper"><meta name="groc-project-path" content="thinkspace-casespace/db/helpers/seed_config/casespace_config_models_helper.rb"><meta name="groc-branch-path" content="development"><meta name="groc-github-url" content="https://github.com/sixthedge/ethinkspace-api"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/ethinkspace-api/blob/development/thinkspace-casespace/db/helpers/seed_config/casespace_config_models_helper.rb">thinkspace-casespace/db/helpers/seed_config/casespace_config_models_helper.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="comments "><div class="wrapper"><p>Allow model titles (e.g. assignments and phases) to be identical
in different configs.
Collects the model ids created by a config which can be used to
add the ids to the &#39;find_by&#39; options e.g. id: [1,2,3].
Currently implemented for spaces, assignments and phases.
To prevent adding the ids to the find_by call &#39;clear_find_by&#39;.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">require</span> <span class="hljs-string">'pp'</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CasespaceConfigModels</span></span>

  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:config_model_ids</span>
  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:find_config_name</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(caller, seed)</span></span>
    <span class="hljs-variable">@caller</span>           = caller
    <span class="hljs-variable">@seed</span>             = seed
    <span class="hljs-variable">@config_model_ids</span> = new_hash
    clear_find_by
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(config, model)</span></span>
    config_model_ids_array(config_name(config), model).push(model.id)
    set_find_by(config)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_by_ids</span><span class="hljs-params">(klass)</span></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> find_config_name.blank?
    config_model_ids_array(find_config_name, klass)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_find_by</span>;</span> <span class="hljs-variable">@find_config_name</span> = <span class="hljs-keyword">nil</span>; <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_find_by</span><span class="hljs-params">(config)</span>;</span> <span class="hljs-variable">@find_config_name</span> = config_name(config); <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">include_auto_input_model?</span><span class="hljs-params">(model, options)</span>;</span> include_model?(model, options); <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print</span>;</span> pp config_model_ids; <span class="hljs-keyword">end</span>

  private

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">config_model_ids_array</span><span class="hljs-params">(name, model_or_class)</span></span>
    hash             = (config_model_ids[name] ||= new_hash)
    model_class_name = model_or_class.is_a?(<span class="hljs-constant">Class</span>) ? model_or_class.name <span class="hljs-symbol">:</span> model_or_class.<span class="hljs-keyword">class</span>.name
    (hash[model_class_name] ||= <span class="hljs-constant">Array</span>.new)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">include_model?</span><span class="hljs-params">(model, options)</span></span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span> <span class="hljs-keyword">unless</span> config_model_ids_array(find_config_name, model).<span class="hljs-keyword">include</span>?(model.id)
    only   = [options[<span class="hljs-symbol">:only</span>]].flatten.compact
    except = [options[<span class="hljs-symbol">:except</span>]].flatten.compact
    title  = model.title
    <span class="hljs-keyword">case</span>
    <span class="hljs-keyword">when</span> title.blank?
      <span class="hljs-keyword">false</span>
    <span class="hljs-keyword">when</span> only.present?
      only.<span class="hljs-keyword">include</span>?(title)
    <span class="hljs-keyword">when</span> except.present?
      !except.<span class="hljs-keyword">include</span>?(title)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">true</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new_hash</span>;</span> <span class="hljs-constant">HashWithIndifferentAccess</span>.new; <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">config_name</span><span class="hljs-params">(config)</span></span>
    config[<span class="hljs-symbol">:_config_name</span>]
  <span class="hljs-keyword">end</span>

<span class="hljs-keyword">end</span></div></div></div></div></body></html>