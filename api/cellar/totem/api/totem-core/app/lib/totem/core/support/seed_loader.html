<!DOCTYPE html><html lang="en"><head><title>totem/api/totem-core/app/lib/totem/core/support/seed_loader</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../../../../"><meta name="groc-document-path" content="totem/api/totem-core/app/lib/totem/core/support/seed_loader"><meta name="groc-project-path" content="src/totem/api/totem-core/app/lib/totem/core/support/seed_loader.rb"><meta name="groc-branch-path" content="master"><meta name="groc-github-url" content="https://github.com/sixthedge/cellar"><link rel="stylesheet" type="text/css" media="all" href="../../../../../../../../assets/style.css"><script type="text/javascript" src="../../../../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/cellar/blob/master/src/totem/api/totem-core/app/lib/totem/core/support/seed_loader.rb">src/totem/api/totem-core/app/lib/totem/core/support/seed_loader.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Totem</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Core</span></span>
    <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Support</span></span>
      <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeedLoader</span></span>

        <span class="hljs-keyword">attr_accessor</span> <span class="hljs-symbol">:load_errors</span>, <span class="hljs-symbol">:quiet</span>, <span class="hljs-symbol">:namespace_lookup</span>, <span class="hljs-symbol">:new_model_class_names</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(options={})</span></span>
          <span class="hljs-variable">@load_errors</span>           = []
          <span class="hljs-variable">@namespace_lookup</span>      = {}
          <span class="hljs-variable">@new_model_class_names</span> = []
          <span class="hljs-variable">@print_tables</span>          = options.has_key?(<span class="hljs-symbol">:print_tables</span>) ? options[<span class="hljs-symbol">:print_tables</span>] <span class="hljs-symbol">:</span> <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_tables</span>;</span> print_models;  <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_namespaces</span><span class="hljs-params">(namespaces)</span></span>
          namespaces.each <span class="hljs-keyword">do</span> |key, path|
            namespace_lookup[key] = <span class="hljs-keyword">nil</span>
            set_namespace(key, path)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_namespace</span><span class="hljs-params">(key, path)</span></span>
          raise_error <span class="hljs-string">"Namespace with key [<span class="hljs-subst">#{key}</span>] already exists"</span>  <span class="hljs-keyword">if</span> namespace_lookup[key].present?
          namespace_name = path.to_s.camelize
          namespace      = namespace_name.safe_constantize
          <span class="hljs-keyword">if</span> namespace.present?
            namespace_lookup[key] = namespace
          <span class="hljs-keyword">else</span>
            message <span class="hljs-string">"Key [<span class="hljs-subst">#{key.inspect}</span>] to namespace [<span class="hljs-subst">#{namespace_name.inspect}</span>] cannot be constantized.  Any references to this key will result in an error."</span>
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">message</span><span class="hljs-params">(msg, level=<span class="hljs-symbol">:info</span>)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> quiet &amp;&amp; level != <span class="hljs-symbol">:error</span>
          <span class="hljs-keyword">return</span> puts <span class="hljs-string">''</span> <span class="hljs-keyword">if</span> msg.blank?
          msg.each_line <span class="hljs-keyword">do</span> |m|
            m.blank? ? puts(<span class="hljs-string">''</span>) <span class="hljs-symbol">:</span> puts(<span class="hljs-string">"[seed <span class="hljs-subst">#{level}</span>] "</span> + m)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load</span><span class="hljs-params">(*args)</span></span>
          options    = args.extract_options!
          seed_files = options[<span class="hljs-symbol">:seeds</span>]      || <span class="hljs-keyword">nil</span>
          test_files = options[<span class="hljs-symbol">:test_data</span>]  || <span class="hljs-keyword">nil</span>
          <span class="hljs-variable">@quiet</span>     = options[<span class="hljs-symbol">:quiet</span>]      || <span class="hljs-keyword">false</span>

          <span class="hljs-constant">ActiveRecord::Base</span>.transaction <span class="hljs-keyword">do</span>
            [seed_files].flatten.compact.each <span class="hljs-keyword">do</span> |seed_file|
              message <span class="hljs-string">"Processing seed file [<span class="hljs-subst">#{seed_file}</span>]"</span>
              <span class="hljs-keyword">require</span> seed_file
              raise_error <span class="hljs-keyword">if</span> has_errors?   <span class="hljs-comment"># rollback all changes if there are seed errors</span>
              seed_results
            <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">if</span> load_test_data?
              [test_files].flatten.compact.each <span class="hljs-keyword">do</span> |test_file|
                message <span class="hljs-string">"Processing test data seed file [<span class="hljs-subst">#{test_file}</span>]"</span>
                <span class="hljs-keyword">require</span> test_file
                raise_error <span class="hljs-keyword">if</span> has_errors?  <span class="hljs-comment"># rollback all changes if there are seed errors</span>
                seed_results
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">end</span>
          print_models  <span class="hljs-keyword">if</span> <span class="hljs-variable">@print_tables</span>.present?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_test_data?</span></span>
          <span class="hljs-constant">Rails</span>.env.development? <span class="hljs-keyword">or</span> <span class="hljs-constant">Rails</span>.env.test? <span class="hljs-keyword">or</span> <span class="hljs-constant">Rails</span>.env.production? <span class="hljs-comment"># Heroku</span>
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Dynamic Seed Model Namespaces</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">user_class</span></span>
          klass = resolve_namespace(<span class="hljs-symbol">:user</span>)  <span class="hljs-comment"># user is a special key as it is a fully qualified model class already</span>
          raise_error <span class="hljs-string">"User class [<span class="hljs-subst">#{class_name}</span>] could not be constantized"</span> <span class="hljs-keyword">if</span> klass.blank?
          klass
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">model_class</span><span class="hljs-params">(*args)</span></span>
          options    = args.extract_options!
          ns_key     = args.shift
          model      = args.shift || raise_error(<span class="hljs-string">"Model class cannot be blank [<span class="hljs-subst">#{args.inspect}</span>]"</span>)
          namespace  = resolve_namespace(ns_key)
          model_name = model.to_s.classify
          class_name = <span class="hljs-string">"<span class="hljs-subst">#{namespace}</span>::<span class="hljs-subst">#{model_name}</span>"</span>
          klass      = class_name.safe_constantize
          raise_error <span class="hljs-string">"Class [<span class="hljs-subst">#{class_name}</span>] could not be constantized"</span> <span class="hljs-keyword">if</span> klass.blank?   <span class="hljs-comment"># rollback all changes if there are seed errors</span>
          klass
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new_model</span><span class="hljs-params">(*args)</span></span>
          options = args.extract_options!
          ns_key  = args.shift
          model   = args.shift
          klass   = model_class(ns_key, model, options)
          new_model_class_names.push(klass.name)  <span class="hljs-keyword">unless</span> new_model_class_names.<span class="hljs-keyword">include</span>?(klass.name)
          model = klass.new
          options.blank? ? model <span class="hljs-symbol">:</span> populate_model(model, options)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">populate_model</span><span class="hljs-params">(model, options)</span></span>
          attrs = model.attribute_names
          model.<span class="hljs-keyword">class</span>.stored_attributes.each {|k,v| attrs += v}
          attrs.each <span class="hljs-keyword">do</span> |a|
            a_sym = a.to_sym
            <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> a_sym == <span class="hljs-symbol">:id</span>

            <span class="hljs-keyword">case</span>
            <span class="hljs-keyword">when</span> a.to_s.end_with?(<span class="hljs-string">'_id'</span>)
              <span class="hljs-keyword">if</span> (id = options[a_sym]).present?
                model.send <span class="hljs-string">"<span class="hljs-subst">#{a_sym}</span>="</span>, id
              <span class="hljs-keyword">else</span>
                assoc_sym = a.sub(<span class="hljs-regexp">/_id$/</span>,<span class="hljs-string">''</span>).to_sym
                <span class="hljs-keyword">if</span> (assoc = options[assoc_sym]).present?
                  model.send <span class="hljs-string">"<span class="hljs-subst">#{a_sym}</span>="</span>, assoc.id
                <span class="hljs-keyword">end</span>
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">when</span> a.to_s.end_with?(<span class="hljs-string">'_type'</span>)  <span class="hljs-comment"># assume polymorphic type</span>
              assoc_sym = a.sub(<span class="hljs-regexp">/_type$/</span>,<span class="hljs-string">''</span>).to_sym
              <span class="hljs-keyword">if</span> (assoc = options[assoc_sym]).present?
                model.send <span class="hljs-string">"<span class="hljs-subst">#{a_sym}</span>="</span>, assoc.<span class="hljs-keyword">class</span>.name
              <span class="hljs-keyword">else</span>
                model.send <span class="hljs-string">"<span class="hljs-subst">#{a_sym}</span>="</span>, options[a_sym]  <span class="hljs-keyword">if</span> options.has_key?(a_sym)
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">else</span>
              model.send <span class="hljs-string">"<span class="hljs-subst">#{a_sym}</span>="</span>, options[a_sym]  <span class="hljs-keyword">if</span> options.has_key?(a_sym)
            <span class="hljs-keyword">end</span>

          <span class="hljs-keyword">end</span>
          model
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_association</span><span class="hljs-params">(*args)</span></span>
          options          = args.extract_options!
          model            = args.shift
          ns_key           = args.shift
          association      = args.shift
          options[<span class="hljs-symbol">:assign</span>] = <span class="hljs-keyword">false</span>
          assoc_name       = resolve_association_name(model, ns_key, association, options)
          model.send(assoc_name)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_association</span><span class="hljs-params">(*args)</span></span>
          options          = args.extract_options!
          model            = args.shift
          ns_key           = args.shift
          association      = args.shift
          value            = args.shift
          options[<span class="hljs-symbol">:assign</span>] = <span class="hljs-keyword">true</span>
          name             = resolve_association_name(model, ns_key, association, options)
          model.send(name, value)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_namespace</span><span class="hljs-params">(ns_key)</span></span>
          namespace_lookup[ns_key] || raise_error(<span class="hljs-string">"Namespace key [<span class="hljs-subst">#{ns_key}</span>] is not set"</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_association_name</span><span class="hljs-params">(*args)</span></span>
          options     = args.extract_options!
          model       = args.shift
          ns_key      = args.shift
          association = args.shift
          namespace   = resolve_namespace(ns_key)
          namespace   = namespace.to_s.underscore.gsub(<span class="hljs-string">'/'</span>,<span class="hljs-string">'_'</span>)
          namespace  += <span class="hljs-string">'_'</span> + association.to_s.underscore
          association_name = options[<span class="hljs-symbol">:assign</span>] ? <span class="hljs-string">"<span class="hljs-subst">#{namespace}</span>="</span>.to_sym <span class="hljs-symbol">:</span> namespace.to_sym
          raise_error <span class="hljs-string">"Model [<span class="hljs-subst">#{model}</span> does not have association method [<span class="hljs-subst">#{association_name}</span>]"</span>  <span class="hljs-keyword">unless</span> model.respond_to?(association_name)
          association_name
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Test Seed Data</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_data_seed_name</span></span>
          name = <span class="hljs-constant">ENV</span>[<span class="hljs-string">'TOTEM_TEST_DATA_SEED_NAME'</span>]
          name.present? ? name <span class="hljs-symbol">:</span> <span class="hljs-constant">Rails</span>.env.test? ? <span class="hljs-string">'test'</span> <span class="hljs-symbol">:</span> <span class="hljs-string">'default'</span>
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Test Config File</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_config_names</span></span>
          configs = <span class="hljs-constant">ENV</span>[<span class="hljs-string">'CONFIG'</span>] || <span class="hljs-string">'default'</span>
          configs.split(<span class="hljs-string">','</span>).map {|c| c.to_s.strip}
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_config_auto_input?</span></span>
          auto_input = <span class="hljs-constant">ENV</span>[<span class="hljs-string">'AUTO_INPUT'</span>] || <span class="hljs-constant">ENV</span>[<span class="hljs-string">'AI'</span>] || <span class="hljs-keyword">false</span>
          (auto_input.present? &amp;&amp; auto_input == <span class="hljs-string">'true'</span>) || <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_config_file</span><span class="hljs-params">(options={})</span></span>
          file = test_config_file_path(options)
          message <span class="hljs-string">"&gt;&gt;Loading config file <span class="hljs-subst">#{file.inspect}</span>."</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>YAML.load(ERB.new(File.read(file)).result).deep_symbolize_keys  # if want to ERB the config files</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-constant">YAML</span>.load(<span class="hljs-constant">File</span>.read(file)).deep_symbolize_keys
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_config_content</span><span class="hljs-params">(options={})</span>;</span> <span class="hljs-constant">File</span>.read(test_config_file_path(options)); <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_config_file_path</span><span class="hljs-params">(options={})</span></span>
          options.symbolize_keys!
          ns_key   = options[<span class="hljs-symbol">:namespace</span>]
          data_dir = options[<span class="hljs-symbol">:test_data_dir</span>] || test_data_seed_name
          filename = options[<span class="hljs-symbol">:config</span>]
          raise_error <span class="hljs-string">"Namespace is blank in options <span class="hljs-subst">#{options.inspect}</span>"</span>  <span class="hljs-keyword">if</span> ns_key.blank?
          raise_error <span class="hljs-string">"Test data directory is blank in options <span class="hljs-subst">#{options.inspect}</span>"</span>  <span class="hljs-keyword">if</span> data_dir.blank?
          raise_error <span class="hljs-string">"Config name is blank in options <span class="hljs-subst">#{options.inspect}</span>"</span>  <span class="hljs-keyword">if</span> filename.blank?
          file = <span class="hljs-constant">File</span>.join(db_data_dir(ns_key.to_sym), data_dir, <span class="hljs-string">"_config_<span class="hljs-subst">#{filename}</span>.yml"</span>)
          file = <span class="hljs-constant">File</span>.join(db_data_dir(ns_key.to_sym), data_dir, <span class="hljs-string">"<span class="hljs-subst">#{filename}</span>.yml"</span>)  <span class="hljs-keyword">unless</span> <span class="hljs-constant">File</span>.exists?(file) <span class="hljs-comment"># _config_filename (legacy version) doesn't exsit try without _config_</span>
          raise_error <span class="hljs-string">"Missing config file: <span class="hljs-subst">#{file}</span>"</span>  <span class="hljs-keyword">unless</span> <span class="hljs-constant">File</span>.exists?(file)
          file
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_import_file</span><span class="hljs-params">(options={})</span></span>
          file = test_import_file_path(options)
          message <span class="hljs-string">"&gt;&gt;Loading import file <span class="hljs-subst">#{file.inspect}</span>."</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>YAML.load(ERB.new(File.read(file)).result).deep_symbolize_keys  # if want to ERB the config files</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-constant">YAML</span>.load(<span class="hljs-constant">File</span>.read(file)).deep_symbolize_keys
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_import_content</span><span class="hljs-params">(options={})</span>;</span> <span class="hljs-constant">File</span>.read(test_import_file_path(options)); <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_import_file_path</span><span class="hljs-params">(options={})</span></span>
          options.symbolize_keys!
          ns_key   = options[<span class="hljs-symbol">:namespace</span>]
          data_dir = options[<span class="hljs-symbol">:test_data_dir</span>] || test_data_seed_name
          filename = options[<span class="hljs-symbol">:import</span>]
          raise_error <span class="hljs-string">"Namespace is blank in options <span class="hljs-subst">#{options.inspect}</span>"</span>  <span class="hljs-keyword">if</span> ns_key.blank?
          raise_error <span class="hljs-string">"Test data directory is blank in options <span class="hljs-subst">#{options.inspect}</span>"</span>  <span class="hljs-keyword">if</span> data_dir.blank?
          raise_error <span class="hljs-string">"Import name is blank in options <span class="hljs-subst">#{options.inspect}</span>"</span>  <span class="hljs-keyword">if</span> filename.blank?
          file = <span class="hljs-constant">File</span>.join(db_data_dir(ns_key.to_sym), data_dir, <span class="hljs-string">"<span class="hljs-subst">#{filename}</span>.yml"</span>)
          raise_error <span class="hljs-string">"Missing import file: <span class="hljs-subst">#{file}</span>"</span>  <span class="hljs-keyword">unless</span> <span class="hljs-constant">File</span>.exists?(file)
          file
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Engine db Directory</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_dir</span><span class="hljs-params">(ns_key)</span></span>
          namespace = resolve_namespace(ns_key)
          namespace = namespace.to_s.underscore.gsub(<span class="hljs-string">'/'</span>,<span class="hljs-string">'_'</span>)
          engine    = <span class="hljs-constant">::Totem::Settings</span>.engine.get_by_name(namespace)
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> engine.blank?
          engine = engine.first
          db_dir = engine.config.paths[<span class="hljs-string">'db'</span>]
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> db_dir.blank?
          db_dir.first
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_data_dir</span><span class="hljs-params">(ns_key)</span></span>
          dir = db_dir(ns_key)
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> dir.blank?
          <span class="hljs-constant">File</span>.join(dir, <span class="hljs-string">'test_data'</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_helpers_dir</span><span class="hljs-params">(ns_key)</span></span>
          dir = db_dir(ns_key)
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> dir.blank?
          <span class="hljs-constant">File</span>.join(dir, <span class="hljs-string">'helpers'</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">require_platform_helpers</span><span class="hljs-params">(platform_name)</span></span>
          <span class="hljs-variable">@_required_platform_helpers</span> ||= <span class="hljs-constant">Array</span>.new
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-variable">@_required_platform_helpers</span>.<span class="hljs-keyword">include</span>?(platform_name.to_sym)  <span class="hljs-comment"># already required</span>
          message <span class="hljs-string">"++Requiring platform <span class="hljs-subst">#{platform_name.to_s.inspect}</span> seed helpers."</span>
          <span class="hljs-variable">@_required_platform_helpers</span>.push platform_name.to_sym
          get_platform_helper_files(platform_name).each <span class="hljs-keyword">do</span> |helper|
            <span class="hljs-keyword">require</span> helper
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">require_helper</span><span class="hljs-params">(ns_key, filename)</span></span>
          helpers_dir = db_helpers_dir(ns_key)
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> helpers_dir.blank?
          filename = filename.to_s
          filename += <span class="hljs-string">'_helper'</span>  <span class="hljs-keyword">unless</span> filename.end_with?(<span class="hljs-string">'_helper'</span>)
          <span class="hljs-keyword">require</span> <span class="hljs-constant">File</span>.join(helpers_dir, filename)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">require_data_files</span><span class="hljs-params">(ns_key, dir)</span></span>
          root_data_dir = db_data_dir(ns_key)
          data_dir      = <span class="hljs-constant">File</span>.join(root_data_dir, dir.to_s)
          files         = <span class="hljs-constant">Array</span>.new
          <span class="hljs-keyword">if</span> <span class="hljs-constant">Dir</span>.exist?(data_dir)
            dir_files = <span class="hljs-constant">Dir</span>.glob(<span class="hljs-constant">File</span>.join(data_dir, <span class="hljs-string">'*.rb'</span>))
            files += dir_files <span class="hljs-keyword">if</span> dir_files.present?
          <span class="hljs-keyword">end</span>
          dir_files.each <span class="hljs-keyword">do</span> |file|
            <span class="hljs-keyword">next</span> <span class="hljs-keyword">if</span> <span class="hljs-constant">File</span>.basename(file).start_with?(<span class="hljs-string">'_'</span>)
            <span class="hljs-keyword">require</span> file
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">require_data_file</span><span class="hljs-params">(ns_key, filename)</span></span>
          root_data_dir = db_data_dir(ns_key)
          file          = <span class="hljs-constant">File</span>.join(root_data_dir, filename.to_s)
          raise_error <span class="hljs-string">"File <span class="hljs-subst">#{file.inspect}</span> is not a file and cannot be required."</span> <span class="hljs-keyword">unless</span> <span class="hljs-constant">File</span>.file?(file)
          <span class="hljs-keyword">require</span> file
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_platform_helper_files</span><span class="hljs-params">(platform_name)</span></span>
          raise_error <span class="hljs-string">"Platform name is blank in require platform helpers."</span>  <span class="hljs-keyword">if</span> platform_name.blank?
          engine_names = <span class="hljs-constant">::Totem::Settings</span>.engine.name_and_engine
          helpers      = <span class="hljs-constant">Array</span>.new
          engine_names.each <span class="hljs-keyword">do</span> |engine_name, engine|
            engine_platform = <span class="hljs-constant">::Totem::Settings</span>.registered.engine_platform_name(engine_name)
            <span class="hljs-keyword">next</span> <span class="hljs-keyword">unless</span> platform_name.to_s == engine_platform
            db = engine.config.paths[<span class="hljs-string">'db'</span>].first
            <span class="hljs-keyword">next</span> <span class="hljs-keyword">unless</span> db.present?
            helpers_dir = <span class="hljs-constant">File</span>.join(db, <span class="hljs-string">'helpers'</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-constant">Dir</span>.exist?(helpers_dir)
              engine_helpers = <span class="hljs-constant">Dir</span>.glob(<span class="hljs-constant">File</span>.join(helpers_dir, <span class="hljs-string">'*_helper.rb'</span>))
              helpers += engine_helpers <span class="hljs-keyword">if</span> engine_helpers.present?
            <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">end</span>
          helpers
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Include instead of &#39;require&#39;.  Includes methods in @seed.helper.method-name.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">include_platform_helpers</span><span class="hljs-params">(platform_name)</span></span>
          set_helper_instance
          get_platform_helper_files(platform_name).each <span class="hljs-keyword">do</span> |filename|
            helper.instance_eval(get_helper_content(filename))
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">include_helper</span><span class="hljs-params">(ns_key, filename)</span></span>
          helpers_dir = db_helpers_dir(ns_key)
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">nil</span> <span class="hljs-keyword">if</span> helpers_dir.blank?
          set_helper_instance
          filename  = filename.to_s
          filename += <span class="hljs-string">'_helper'</span>  <span class="hljs-keyword">unless</span> filename.end_with?(<span class="hljs-string">'_helper'</span>)
          filename += <span class="hljs-string">'.rb'</span>      <span class="hljs-keyword">unless</span> filename.end_with?(<span class="hljs-string">'.rb'</span>)
          filename  = <span class="hljs-constant">File</span>.join(helpers_dir, filename)
          content   = get_helper_content(filename)
          helper.instance_eval(get_helper_content(filename))
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_helper_content</span><span class="hljs-params">(filename)</span></span>
          raise_error <span class="hljs-string">"Helper file <span class="hljs-subst">#{filename.inspect}</span> is not a file and cannot be included."</span> <span class="hljs-keyword">unless</span> <span class="hljs-constant">File</span>.file?(filename)
          content = <span class="hljs-constant">File</span>.read(filename)
          content.sub!(<span class="hljs-regexp">/^\s*public.*?\n/</span>, <span class="hljs-string">''</span>) <span class="hljs-keyword">if</span> content.match(<span class="hljs-string">'public'</span>) <span class="hljs-comment"># remove 'public' class statement (methods will be public)</span>
          content
        <span class="hljs-keyword">end</span>

        <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:helper</span>  <span class="hljs-comment"># used to reference the included helper methods e.g. <span class="hljs-doctag">@seed</span>.helper.method-name</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a new class to include the seed helper methods so will not collide with any existing
instance method names (e.g. a minitest instance).</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_helper_instance</span></span>
          <span class="hljs-variable">@helper</span> ||= <span class="hljs-constant">Helper</span>.new(<span class="hljs-keyword">self</span>)
        <span class="hljs-keyword">end</span>

        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Helper</span></span>
          <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(seed_loader)</span></span>
            <span class="hljs-variable">@seed</span> = seed_loader  <span class="hljs-comment"># set <span class="hljs-doctag">@seed</span> to this seed_loader so any included methods can reference <span class="hljs-doctag">@seed</span>.method-name</span>
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Reset Tables</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_tables?</span>;</span> (<span class="hljs-constant">ENV</span>[<span class="hljs-string">'RESET'</span>] || <span class="hljs-constant">ENV</span>[<span class="hljs-string">'R'</span>] || <span class="hljs-keyword">nil</span>) == <span class="hljs-string">'true'</span>; <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Reset tables that start with value(s) in &#39;args&#39; (default is registered engine names).
e.g. @seed.reset_tables; @seed.reset_tables(:thinkspace); @seed.reset_tables(:thinkspace, :totem)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_tables</span><span class="hljs-params">(*args)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> reset_tables?
          table_names = select_reset_tables(args)
          message <span class="hljs-string">"==Resetting <span class="hljs-subst">#{table_names.length}</span> tables."</span>, <span class="hljs-symbol">:warn</span>
          [table_names].flatten.compact.sort.each <span class="hljs-keyword">do</span> |table_name|
            delete_all_table_records(table_name)
          <span class="hljs-keyword">end</span>
          reset_common_tables
          run_domain_loader
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_common_tables</span></span>
          <span class="hljs-keyword">if</span> <span class="hljs-string">'PaperTrail::Version'</span>.safe_constantize.present?
            message <span class="hljs-string">"==Resetting 'versions' table."</span>, <span class="hljs-symbol">:warn</span>
            delete_all_table_records(<span class="hljs-symbol">:versions</span>)
          <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">if</span> <span class="hljs-string">'ActsAsTaggableOn::Tag'</span>.safe_constantize.present?
            message <span class="hljs-string">"==Resetting 'tags' and 'taggings' table."</span>, <span class="hljs-symbol">:warn</span>
            delete_all_table_records(<span class="hljs-symbol">:tags</span>)
            delete_all_table_records(<span class="hljs-symbol">:taggings</span>)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_domain_loader</span></span>
          message <span class="hljs-string">"==Loading domain data."</span>
          <span class="hljs-constant">Totem::Core::Database::Domain::Loader</span>.new.load_files
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">select_reset_tables</span><span class="hljs-params">(args)</span></span>
          engine_names = args.blank? ? <span class="hljs-constant">::Totem::Settings</span>.registered.engines <span class="hljs-symbol">:</span> args
          active_record_base_connection.tables.select {|tn| select_reset_table?(tn, engine_names)}
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">select_reset_table?</span><span class="hljs-params">(table_name, engine_names)</span></span>
          engine_names.each <span class="hljs-keyword">do</span> |en|
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span> <span class="hljs-keyword">if</span> table_name.to_s.start_with?(en.to_s)
          <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_all_table_records</span><span class="hljs-params">(table_name)</span></span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> table_name.blank?
          active_record_base_connection.execute(<span class="hljs-string">"TRUNCATE TABLE <span class="hljs-subst">#{table_name}</span> RESTART IDENTITY"</span>) <span class="hljs-comment"># restart ids at 1</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">active_record_base_connection</span>;</span> <span class="hljs-constant">::ActiveRecord::Base</span>.connection; <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Print table rows</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_models</span></span>
          <span class="hljs-keyword">return</span> puts(<span class="hljs-string">"[stats] No new table rows added"</span>)  <span class="hljs-keyword">if</span> new_model_class_names.blank?
          <span class="hljs-keyword">require</span> <span class="hljs-string">'pp'</span>
          new_model_class_names.sort.each <span class="hljs-keyword">do</span> |name|
            klass = name.safe_constantize
            raise_error <span class="hljs-string">"Could not constantize class name [<span class="hljs-subst">#{name}</span>] to print rows"</span>  <span class="hljs-keyword">if</span> klass.blank?
            print_table(klass)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_table</span><span class="hljs-params">(klass)</span></span>
          puts <span class="hljs-string">"\n===== Table: <span class="hljs-subst">#{klass.name}</span> ===== <span class="hljs-subst">#{klass.name.demodulize}</span>\n"</span>
          pp klass.all
          puts <span class="hljs-string">"\n"</span>
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h6 id="">#</h6>
<p>@!group Seed Errors</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_error</span><span class="hljs-params">(object)</span></span>
          msg = <span class="hljs-string">"\n"</span>
          msg += <span class="hljs-string">"Model:        [<span class="hljs-subst">#{object.<span class="hljs-keyword">class</span>.name}</span>]\n"</span>
          msg += <span class="hljs-string">"Instance:     [<span class="hljs-subst">#{object.inspect}</span>]\n"</span>
          msg += <span class="hljs-string">"Model Errors: [<span class="hljs-subst">#{object.errors.full_messages.join(<span class="hljs-string">', '</span>)}</span>]\n"</span>
          message msg, <span class="hljs-symbol">:error</span>
          raise_error
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_error</span><span class="hljs-params">(msg)</span></span>
          message msg, <span class="hljs-symbol">:error</span>
          load_errors.push(msg)
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_errors?</span></span>
          load_errors.present?
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">raise_error</span><span class="hljs-params">(message=<span class="hljs-string">''</span>)</span></span>
          raise <span class="hljs-string">"Seed exception.  <span class="hljs-subst">#{message}</span>"</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">seed_results</span></span>
          <span class="hljs-keyword">if</span> has_errors?
            message <span class="hljs-string">"*Errors*. Seed completed with <span class="hljs-subst">#{load_errors.length}</span> errors."</span>, <span class="hljs-symbol">:error</span>
          <span class="hljs-keyword">else</span>
            message <span class="hljs-string">"--Successful. Seed completed with no known errors."</span>
            message <span class="hljs-string">"--Check the log or console to make sure there are no mass-assignment warnings."</span>
          <span class="hljs-keyword">end</span>
          message <span class="hljs-string">"\n"</span>
        <span class="hljs-keyword">end</span>

        <span class="hljs-keyword">include</span> <span class="hljs-constant">Shared</span>

      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></div></div></div></div></body></html>