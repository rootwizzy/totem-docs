<!DOCTYPE html><html lang="en"><head><title>lib/tasks/totem/lodestar/helpers/api_generator</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../../"><meta name="groc-document-path" content="lib/tasks/totem/lodestar/helpers/api_generator"><meta name="groc-project-path" content="lib/tasks/totem/lodestar/helpers/api_generator.rb"><meta name="groc-branch-path" content="master"><meta name="groc-github-url" content="https://github.com/sixthedge/totem-lodestar"><link rel="stylesheet" type="text/css" media="all" href="../../../../../assets/style.css"><script type="text/javascript" src="../../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sixthedge/totem-lodestar/blob/master/lib/tasks/totem/lodestar/helpers/api_generator.rb">lib/tasks/totem/lodestar/helpers/api_generator.rb</a></div></div><div id="document"><a href="/" class="lodestar-link">Back to Guides</a><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Totem</span></span>
  <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Lodestar</span></span>
    <span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">ApiGenerator</span></span>
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">included</span><span class="hljs-params">(base)</span></span>
      <span class="hljs-keyword">end</span>
        
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_api_documents</span><span class="hljs-params">(build, is_local)</span></span>
        <span class="hljs-constant">Totem::Lodestar::Api</span>.destroy_all

        <span class="hljs-constant">Settings</span>.modules.api.repositories.each <span class="hljs-keyword">do</span> |repo|
          create_api_record(repo)
        <span class="hljs-keyword">end</span>

        build_groc_documents(is_local) <span class="hljs-keyword">if</span> build
      <span class="hljs-keyword">end</span>

      private

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_groc_documents</span><span class="hljs-params">(is_local)</span></span>
        <span class="hljs-constant">Dir</span>.mktmpdir(<span class="hljs-keyword">nil</span>, <span class="hljs-constant">Dir</span>.pwd) <span class="hljs-keyword">do</span> |dir|
          <span class="hljs-constant">Dir</span>.chdir(dir)

          <span class="hljs-constant">Settings</span>.modules.api.repositories.each <span class="hljs-keyword">do</span> |repo|
            clone_repo(repo, is_local)
            run_groc_cli(repo)
          <span class="hljs-keyword">end</span>

          build_behavior_file</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>build_style_file</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">primary_repo_path</span></span>
        <span class="hljs-string">"/api/"</span> + <span class="hljs-constant">Settings</span>.modules.api.repositories.first.name
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clone_repo</span><span class="hljs-params">(repo, is_local)</span></span>
        <span class="hljs-keyword">if</span> is_local
          sh <span class="hljs-string">"cp ~/Desktop/ember20/repos/<span class="hljs-subst">#{repo.name}</span> <span class="hljs-subst">#{<span class="hljs-constant">Dir</span>.pwd}</span> -r"</span>
        <span class="hljs-keyword">else</span>
          sh <span class="hljs-string">"git clone -b <span class="hljs-subst">#{repo.branch}</span> <span class="hljs-subst">#{repo.url}</span>"</span>
        <span class="hljs-keyword">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>sh &quot;curl -H &#39;Authorization: token #{ENV[&#39;GITHUB_TOKEN&#39;]}&#39; -L <a href="https://api.github.com/repos/sixthedge/#{repo.name}/tarball">https://api.github.com/repos/sixthedge/#{repo.name}/tarball</a> &gt; #{repo.name}.tar.gz&quot;
sh &quot;tar -xvzf #{repo.name}.tar.gz&quot;
sh &quot;rm #{repo.name}.tar.gz&quot;
Dir.foreach(Dir.pwd) do |dir|
  if dir.include?(repo.name)
    sh &quot;cp #{Dir.pwd + &#39;/&#39; + dir} #{Dir.pwd + &#39;/&#39; + repo.name} -r&quot;
    sh &quot;rm #{Dir.pwd + &#39;/&#39; + dir} -r&quot;
  end
end</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_groc_cli</span><span class="hljs-params">(repo)</span></span>
        <span class="hljs-constant">Dir</span>.chdir(repo.name)
        sh <span class="hljs-string">"<span class="hljs-subst">#{groc_cli(repo.options)}</span>"</span>
        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-string">'..'</span>)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_api_record</span><span class="hljs-params">(repo)</span></span>
        <span class="hljs-constant">Totem::Lodestar::Api</span>.find_or_create_by(<span class="hljs-symbol">title:</span> repo.name)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">groc_cli</span><span class="hljs-params">(options)</span></span>
        bin = <span class="hljs-string">"../../node_modules/.bin/groc "</span>

        options.each <span class="hljs-keyword">do</span> |opt|
          bin += opt[<span class="hljs-number">1</span>] + <span class="hljs-string">" "</span> <span class="hljs-keyword">unless</span> opt.<span class="hljs-keyword">include</span>?(<span class="hljs-symbol">:glob</span>)
        <span class="hljs-keyword">end</span>

        bin += options[<span class="hljs-string">'glob'</span>]
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_behavior_file</span></span>
        create_file(<span class="hljs-string">"behavior.js"</span>, <span class="hljs-string">"/api/assets"</span>)
        scrape_jquery_min
        scrape_table_of_contents
        scrape_groc_helpers
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_style_file</span></span>
        create_file(<span class="hljs-string">"style.css"</span>, <span class="hljs-string">"/api/assets"</span>)
        scrape_styles
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_file</span><span class="hljs-params">(file, path)</span></span>
        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, path))
        <span class="hljs-constant">File</span>.delete(file) <span class="hljs-keyword">if</span> <span class="hljs-constant">File</span>.exists?(file)
        <span class="hljs-constant">File</span>.open(file, <span class="hljs-string">"w+"</span>)
        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">Rails</span>.application.root)
      <span class="hljs-keyword">end</span>
   
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scrape_styles</span></span>
        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, primary_repo_path))

        lines = []
        <span class="hljs-constant">File</span>.open(<span class="hljs-constant">Dir</span>.pwd + <span class="hljs-string">'/assets/style.css'</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">do</span> |file|
          file.each_line <span class="hljs-keyword">do</span> |line|
            lines.push(line) 
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        write_file(<span class="hljs-string">'style.css'</span>, <span class="hljs-string">"w+"</span>, lines)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scrape_jquery_min</span></span>
        lines = []
        scan  = <span class="hljs-keyword">true</span>

        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, primary_repo_path))

        <span class="hljs-constant">File</span>.open(<span class="hljs-constant">Dir</span>.pwd + <span class="hljs-string">'/assets/behavior.js'</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">do</span> |file|
          file.each_line <span class="hljs-keyword">do</span> |l| 
            lines.push(l) <span class="hljs-keyword">if</span> scan == <span class="hljs-keyword">true</span>

            scan = <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> l.eql?(<span class="hljs-string">"  var MAX_FILTER_SIZE, appendSearchNode, buildNav, buildTOCNode, clearFilter, clearHighlight, currentNode$, currentQuery, fileMap, focusCurrentNode, highlightMatch, moveCurrentNode, nav$, searchNodes, searchableNodes, selectNode, selectNodeByDocumentPath, setCurrentNodeExpanded, setTableOfContentsActive, tableOfContents, toc$, toggleTableOfContents, visitCurrentNode;\n"</span>)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        write_file(<span class="hljs-string">'behavior.js'</span>, <span class="hljs-string">"a"</span>, lines)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scrape_table_of_contents</span></span>
        files = []
        scan  = <span class="hljs-keyword">false</span>

        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, <span class="hljs-string">"/api"</span>))

        <span class="hljs-constant">Dir</span>.foreach(<span class="hljs-constant">Dir</span>.pwd) <span class="hljs-keyword">do</span> |repo|
          <span class="hljs-keyword">unless</span> repo.eql?(<span class="hljs-string">"."</span>) <span class="hljs-keyword">or</span> repo.eql?(<span class="hljs-string">".."</span>) <span class="hljs-keyword">or</span> repo.eql?(<span class="hljs-string">"assets"</span>)
            toc_lines = []
            <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, <span class="hljs-string">'/api/'</span>, repo, <span class="hljs-string">'assets'</span>))
            <span class="hljs-constant">File</span>.open(<span class="hljs-constant">Dir</span>.pwd + <span class="hljs-string">'/behavior.js'</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">do</span> |file|
              file.each_line <span class="hljs-keyword">do</span> |line|
                scan = <span class="hljs-keyword">true</span> <span class="hljs-keyword">if</span> line.eql?(<span class="hljs-string">"  tableOfContents = [\n"</span>)
                toc_lines.push(line) <span class="hljs-keyword">if</span> scan
                scan = <span class="hljs-keyword">false</span> <span class="hljs-keyword">if</span> line.eql?(<span class="hljs-string">"  ];\n"</span>)
              <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>

            toc_lines.pop
            toc_lines.shift

            toc_lines.pop
            toc_lines.push(<span class="hljs-string">"    },\n"</span>)

            files.push(toc_lines)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        files.unshift([<span class="hljs-string">"  tableOfContents = [\n"</span>])
        files.push([<span class="hljs-string">"  ];\n"</span>])

        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, <span class="hljs-string">"/api/assets"</span>))

        <span class="hljs-constant">File</span>.open(<span class="hljs-string">'behavior.js'</span>, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">do</span> |f|
          files.each <span class="hljs-keyword">do</span> |toc_lines|
            toc_lines.each { |l| f.write(l) }
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scrape_groc_helpers</span></span>
        scan  = <span class="hljs-keyword">false</span>
        lines = []

        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, primary_repo_path))

        <span class="hljs-constant">File</span>.open(<span class="hljs-constant">Dir</span>.pwd + <span class="hljs-string">'/assets/behavior.js'</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">do</span> |file|
          file.each_line <span class="hljs-keyword">do</span> |line|
            scan = <span class="hljs-keyword">true</span> <span class="hljs-keyword">if</span> line.eql?(<span class="hljs-string">"  nav$ = null;\n"</span>)
            lines.push(line) <span class="hljs-keyword">if</span> scan
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>

        write_file(<span class="hljs-string">'behavior.js'</span>, <span class="hljs-string">"a"</span>, lines)
      <span class="hljs-keyword">end</span>

      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write_file</span><span class="hljs-params">(file, mode=<span class="hljs-string">"w+"</span>, lines)</span></span>
        <span class="hljs-constant">Dir</span>.chdir(<span class="hljs-constant">File</span>.join(<span class="hljs-constant">Rails</span>.application.root, <span class="hljs-string">"/api/assets"</span>))

        <span class="hljs-constant">File</span>.open(file, mode) <span class="hljs-keyword">do</span> |f|
          <span class="hljs-keyword">if</span> lines.kind_of?(<span class="hljs-constant">Array</span>)
            lines.each {|l| f.write(l)}
          <span class="hljs-keyword">else</span>
            f.write(lines)
          <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
      <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></div></div></div></div></body></html>